# Интеграция с Tilda

Пошаговое руководство по подключению бонусной системы Gupil к сайтам на платформе Tilda.

## Обзор

Tilda — популярный конструктор сайтов, который позволяет создавать интернет-магазины без программирования. Gupil интегрируется с Tilda через:

1. **Webhook** — для автоматического начисления бонусов при покупках
2. **Виджет баланса** — для отображения бонусов пользователя на сайте
3. **Промокоды** — для списания бонусов при оплате

## Шаг 1: Подключение Webhook

Webhook позволяет автоматически передавать данные о заказах из Tilda в Gupil для начисления бонусов.

### 1.1 Получите Webhook URL

1. Откройте ваш проект в админ-панели Gupil
2. Перейдите в раздел **"Интеграция"**
3. Скопируйте **Webhook URL** — он выглядит так:
   ```
   https://yourdomain.com/api/webhook/abc123def456
   ```

### 1.2 Настройте Webhook в Tilda

1. Откройте настройки сайта в Tilda
2. Перейдите в раздел **"Формы" → "Уведомления"**
3. Нажмите **"Добавить webhook"**
4. Вставьте скопированный Webhook URL
5. Выберите формат данных **JSON**

![Подключение Webhook в Tilda](/Подключение%20Webhook%20тильда.jpg)

### 1.3 Настройте передаваемые поля

Убедитесь, что в webhook передаются следующие поля:
- **Email** — обязательно для идентификации пользователя
- **Телефон** — дополнительный идентификатор
- **Сумма заказа** — для расчета бонусов
- **Номер заказа** — для отслеживания транзакций
- **Имя и фамилия** — для персонализации

### 1.4 Проверьте интеграцию

1. Сделайте тестовый заказ на сайте
2. Проверьте в админ-панели Gupil раздел **"Логи"**
3. Убедитесь, что данные заказа получены
4. Проверьте начисление бонусов пользователю

## Шаг 2: Подключение виджета баланса

Виджет показывает пользователю его текущий баланс бонусов прямо на сайте.

### 2.1 Получите код виджета

1. В админ-панели Gupil перейдите в **"Интеграция" → "Виджеты"**
2. Скопируйте код виджета для вашего проекта

### 2.2 Добавьте виджет на сайт Tilda

1. В редакторе Tilda добавьте блок **"HTML-код"** (T123)
2. Вставьте код виджета:

```html
<script src="https://yourdomain.com/tilda-bonus-widget.js"></script>
<script>
window.addEventListener('DOMContentLoaded', function() {
  TildaBonusWidget.init({
    projectId: 'your-project-id',
    apiUrl: 'https://yourdomain.com/api',
    position: 'bottom-right', // или 'bottom-left', 'top-right', 'top-left'
    theme: 'light' // или 'dark'
  });
});
</script>
```

### 2.3 Размещение в футере

Для отображения виджета на всех страницах сайта, добавьте код в **футер сайта**:

1. Откройте **Настройки сайта → Ещё → HTML-код для вставки внутрь HEAD или перед /BODY**
2. Вставьте код виджета в поле **"Перед закрывающим тегом BODY"**
3. Сохраните настройки

![Подключение виджета в футер Tilda](/Подключение%20виджета%20на%20сайт%20Tilda%20footer.png)

### 2.4 Настройка внешнего вида

Виджет можно настроить под дизайн вашего сайта:

```html
<script>
TildaBonusWidget.init({
  projectId: 'your-project-id',
  apiUrl: 'https://yourdomain.com/api',
  position: 'bottom-right',
  theme: 'custom',
  styles: {
    backgroundColor: '#ffffff',
    textColor: '#333333',
    accentColor: '#ff6b00',
    borderRadius: '12px',
    fontFamily: 'inherit'
  }
});
</script>
```

## Шаг 3: Подключение промокодов (списание бонусов)

Промокоды позволяют пользователям списывать накопленные бонусы при оплате заказа.

### 3.1 Включите промокоды в корзине Tilda

1. Откройте настройки корзины в редакторе Tilda
2. Перейдите в раздел **"Промокоды"**
3. Включите опцию **"Показывать поле для промокода"**

![Подключение промокода в Tilda](/Подключение%20промокода%20Tilda.jpg)

### 3.2 Настройте валидацию промокодов

Для проверки промокодов через Gupil API добавьте скрипт валидации:

```html
<script>
// Валидация промокода через Gupil API
window.tildaPromoCodeValidation = async function(promoCode, cartData) {
  try {
    const response = await fetch('https://yourdomain.com/api/validate-promo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        projectId: 'your-project-id',
        promoCode: promoCode,
        email: cartData.email,
        cartTotal: cartData.total
      })
    });
    
    const result = await response.json();
    
    if (result.valid) {
      return {
        valid: true,
        discount: result.discount,
        message: `Скидка ${result.discount} ₽ применена!`
      };
    } else {
      return {
        valid: false,
        message: result.message || 'Промокод недействителен'
      };
    }
  } catch (error) {
    return {
      valid: false,
      message: 'Ошибка проверки промокода'
    };
  }
};
</script>
```

### 3.3 Как работают бонусные промокоды

1. Пользователь вводит свой **персональный промокод** (генерируется в Telegram боте)
2. Система проверяет баланс бонусов пользователя
3. При достаточном балансе — применяется скидка
4. После оплаты заказа — бонусы списываются автоматически

### 3.4 Генерация промокодов для пользователей

Пользователи получают персональные промокоды через Telegram бота:

1. Пользователь отправляет команду `/promo` боту
2. Бот генерирует уникальный промокод на основе баланса
3. Промокод действителен ограниченное время (настраивается)
4. При использовании — бонусы списываются

## Полный пример интеграции

### Код для вставки в футер Tilda:

```html
<!-- Gupil Bonus Widget -->
<script src="https://yourdomain.com/tilda-bonus-widget.js"></script>
<script>
(function() {
  // Инициализация виджета
  window.addEventListener('DOMContentLoaded', function() {
    TildaBonusWidget.init({
      projectId: 'your-project-id',
      apiUrl: 'https://yourdomain.com/api',
      position: 'bottom-right',
      theme: 'light',
      showOnPages: ['*'], // на всех страницах
      hideOnMobile: false
    });
  });
  
  // Отслеживание успешных заказов
  window.addEventListener('tildaform:aftersuccess', function(e) {
    var formData = e.detail;
    
    // Дополнительная отправка данных в Gupil (если нужно)
    if (formData.formtype === 'cart') {
      console.log('Заказ оформлен, данные отправлены в Gupil через webhook');
    }
  });
})();
</script>
```

## Тестирование интеграции

### Чек-лист проверки:

1. **Webhook**
   - [ ] Тестовый заказ создает пользователя в Gupil
   - [ ] Бонусы начисляются корректно
   - [ ] Данные заказа отображаются в логах

2. **Виджет баланса**
   - [ ] Виджет отображается на сайте
   - [ ] Баланс обновляется после авторизации
   - [ ] Виджет корректно работает на мобильных

3. **Промокоды**
   - [ ] Промокод применяется в корзине
   - [ ] Скидка рассчитывается правильно
   - [ ] Бонусы списываются после оплаты

## Частые проблемы и решения

### Webhook не работает

**Проблема:** Данные не поступают в Gupil

**Решения:**
1. Проверьте правильность Webhook URL
2. Убедитесь, что выбран формат JSON
3. Проверьте, что форма заказа настроена на отправку webhook
4. Посмотрите логи в админ-панели Gupil

### Виджет не отображается

**Проблема:** Виджет не появляется на сайте

**Решения:**
1. Проверьте, что код добавлен перед `</body>`
2. Откройте консоль браузера (F12) и проверьте ошибки
3. Убедитесь, что `projectId` указан правильно
4. Проверьте, что скрипт виджета загружается

### Промокод не применяется

**Проблема:** Промокод показывает ошибку

**Решения:**
1. Проверьте, что у пользователя есть бонусы
2. Убедитесь, что промокод не истек
3. Проверьте минимальную сумму заказа для списания
4. Посмотрите логи API в админ-панели

## Дополнительные возможности

### Отслеживание UTM-меток

Tilda автоматически передает UTM-метки в webhook. Gupil сохраняет их для аналитики:

- `utm_source` — источник трафика
- `utm_medium` — тип трафика
- `utm_campaign` — название кампании
- `utm_content` — содержание объявления
- `utm_term` — ключевое слово

### Интеграция с CRM

Если вы используете CRM (RetailCRM, amoCRM), данные из Tilda можно передавать через Gupil:

1. Настройте webhook в Tilda → Gupil
2. Настройте интеграцию Gupil → CRM
3. Данные будут синхронизироваться автоматически

---

**Нужна помощь?** Обратитесь в поддержку: support@gupil.ru или @gupil_support в Telegram.
