# Конструктор сценариев (Workflow)

Визуальный конструктор позволяет создавать сложные сценарии взаимодействия с пользователями без написания кода. Вы соединяете блоки (ноды) линиями, определяя логику работы бота.

---

## Основные понятия

- **Нода (Node)** — отдельный блок сценария (триггер, сообщение, условие и т.д.)
- **Связь (Edge)** — линия, соединяющая ноды и определяющая порядок выполнения
- **Триггер** — точка входа в сценарий (команда, сообщение, callback)
- **Переменные** — данные, которые можно использовать в сообщениях: `{{user.balance}}`, `{{user.name}}`

---

## Типы клавиатур

### Inline клавиатура

Кнопки отображаются **под сообщением** и не занимают место системной клавиатуры.

**Возможности:**
- **URL** — открывает ссылку в браузере
- **Callback** — отправляет данные боту для обработки (используется для ветвления)

**Когда использовать:**
- Меню выбора действий
- Навигация по разделам бота
- Кнопки подтверждения/отмены

**Пример:** Кнопки "Получить подарок", "Мой баланс", "Связаться с поддержкой"

### Reply клавиатура

**Заменяет системную клавиатуру** телефона. Постоянно видна пока не уберете.

**Возможности:**
- **Обычный текст** — отправляет текст как сообщение пользователя
- **Запросить контакт** — пользователь делится номером телефона
- **Запросить геолокацию** — пользователь делится местоположением

**Когда использовать:**
- Регистрация (запрос телефона)
- Главное меню бота
- Сбор данных пользователя

**Пример:** Кнопка "Поделиться контактом" для регистрации

---

## Как создать ветвление по кнопкам

1. Добавьте ноду **"Сообщение"** или **"Inline клавиатура"**
2. В настройках добавьте клавиатуру типа **Inline**
3. Создайте кнопки с уникальными `callback_data`:
   - "Получить подарок" → `callback_data: get_gift`
   - "Подтвердить данные" → `callback_data: confirm_data`
4. Добавьте ноду **"Условие"** после сообщения
5. В условии проверяйте: `{{callback_data}} == "get_gift"`
6. Соедините ветки с нужными действиями

---

## Триггеры

Триггеры — это точки входа в сценарий. Каждый workflow должен начинаться с триггера.

### Команда (`trigger.command`)

Запускает сценарий при вводе команды пользователем.

**Настройки:**
- **Команда** — текст команды без слеша (например: `start`, `help`, `balance`)

**Примеры использования:**
- `/start` — приветствие нового пользователя
- `/balance` — показать баланс бонусов
- `/help` — справка по боту

### Сообщение (`trigger.message`)

Запускает сценарий при получении текстового сообщения.

**Настройки:**
- **Паттерн** — текст или регулярное выражение для сопоставления
- **Точное совпадение** — требовать полного совпадения текста

**Примеры использования:**
- Ответ на ключевые слова ("цена", "доставка")
- Обработка произвольного текста

### Callback (`trigger.callback`)

Обрабатывает нажатия на inline-кнопки.

**Настройки:**
- **Callback Data** — данные кнопки для обработки

**Примеры использования:**
- Обработка выбора из меню
- Подтверждение действий
- Навигация по разделам

### Webhook (`trigger.webhook`)

Запускает сценарий при получении внешнего HTTP-запроса.

**Настройки:**
- **Метод** — GET, POST, PUT
- **Путь** — URL endpoint

**Примеры использования:**
- Уведомление о новом заказе
- Интеграция с CRM
- Автоматические рассылки

---

## Сообщения

### Текстовое сообщение (`message`)

Отправляет текстовое сообщение пользователю.

**Настройки:**
- **Текст** — содержимое сообщения (поддерживает переменные и HTML)
- **Клавиатура** — опционально добавить кнопки
- **Parse Mode** — HTML или Markdown

**Переменные:**
```
{{user.firstName}} — имя пользователя
{{user.balance}} — баланс бонусов
{{user.level}} — текущий уровень
{{user.referralLink}} — реферальная ссылка
```

### Inline клавиатура (`message.keyboard.inline`)

Сообщение с кнопками под текстом.

**Настройки:**
- **Текст сообщения**
- **Кнопки** — массив рядов с кнопками
- Каждая кнопка: текст + действие (URL или callback_data)

**Типы кнопок:**
- **URL** — открывает ссылку
- **Callback** — отправляет данные боту

### Reply клавиатура (`message.keyboard.reply`)

Сообщение с постоянной клавиатурой.

**Настройки:**
- **Текст сообщения**
- **Кнопки** — массив рядов
- **Resize** — подогнать размер под текст
- **One-time** — скрыть после нажатия

**Типы кнопок:**
- **Текст** — отправляет текст
- **Запрос контакта** — получить номер телефона
- **Запрос геолокации** — получить местоположение

### Фото (`message.photo`)

Отправляет изображение с подписью.

**Настройки:**
- **URL изображения** или **File ID**
- **Подпись** — текст под фото
- **Клавиатура** — опционально

### Видео (`message.video`)

Отправляет видеоролик.

**Настройки:**
- **URL видео** или **File ID**
- **Подпись**
- **Клавиатура**

### Документ (`message.document`)

Отправляет файл.

**Настройки:**
- **URL файла** или **File ID**
- **Имя файла**
- **Подпись**

### Редактировать (`message.edit`)

Редактирует ранее отправленное сообщение.

**Настройки:**
- **Message ID** — ID сообщения для редактирования
- **Новый текст**
- **Новая клавиатура**

### Удалить (`message.delete`)

Удаляет сообщение из чата.

**Настройки:**
- **Message ID** — ID сообщения для удаления

---

## Действия

### API запрос (`action.api_request`)

Выполняет HTTP-запрос к внешнему сервису.

**Настройки:**
- **URL** — адрес API
- **Метод** — GET, POST, PUT, DELETE
- **Headers** — заголовки запроса
- **Body** — тело запроса (для POST/PUT)
- **Переменная результата** — куда сохранить ответ

**Примеры:**
- Получение данных из CRM
- Отправка данных в аналитику
- Интеграция с платежными системами

### База данных (`action.database_query`)

Выполняет безопасный запрос к базе данных.

**Настройки:**
- **Тип запроса** — get_user_profile, get_balance, get_transactions
- **Параметры** — дополнительные фильтры

**Доступные запросы:**
- `get_user_profile` — данные пользователя
- `get_balance` — текущий баланс
- `get_transactions` — история операций
- `get_referral_stats` — статистика рефералов
- `get_referral_link` — реферальная ссылка

### Установить переменную (`action.set_variable`)

Сохраняет значение в переменную для использования далее.

**Настройки:**
- **Имя переменной**
- **Значение** — статическое или выражение

### Получить переменную (`action.get_variable`)

Читает значение переменной.

**Настройки:**
- **Имя переменной**

### Запрос контакта (`action.request_contact`)

Запрашивает номер телефона у пользователя.

**Настройки:**
- **Текст сообщения** — что показать пользователю
- **Текст кнопки** — надпись на кнопке "Поделиться контактом"

### Уведомление (`action.send_notification`)

Отправляет уведомление через разные каналы.

**Настройки:**
- **Канал** — telegram, email, webhook
- **Получатель**
- **Сообщение**

### Проверка связи (`action.check_user_linked`)

Проверяет, привязан ли Telegram аккаунт к пользователю в системе.

**Результат:** `true` или `false` в переменной

### Поиск по контакту (`action.find_user_by_contact`)

Ищет пользователя по телефону или email.

**Настройки:**
- **Телефон** или **Email**

**Результат:** данные пользователя или null

### Привязать Telegram (`action.link_telegram_account`)

Связывает текущий Telegram аккаунт с пользователем в системе.

**Настройки:**
- **User ID** — ID пользователя в системе

### Баланс пользователя (`action.get_user_balance`)

Получает текущий баланс бонусов.

**Результат:** число в переменной `balance`

### Проверка подписки (`action.check_channel_subscription`)

Проверяет, подписан ли пользователь на Telegram канал.

**Настройки:**
- **Channel ID** — @username или числовой ID канала

**Результат:** `true` или `false`

---

## Логика

### Условие (`condition`)

Ветвление сценария по условию.

**Настройки:**
- **Выражение** — условие для проверки

**Операторы:**
- `==` — равно
- `!=` — не равно
- `>`, `<`, `>=`, `<=` — сравнение чисел
- `contains` — содержит подстроку
- `startsWith`, `endsWith` — начинается/заканчивается

**Примеры:**
```
{{user.balance}} > 100
{{callback_data}} == "confirm"
{{user.level}} == "VIP"
```

**Выходы:**
- **true** — условие выполнено
- **false** — условие не выполнено

### Switch (`flow.switch`)

Множественный выбор ветки по значению.

**Настройки:**
- **Переменная** — что проверять
- **Варианты** — список значений и соответствующих веток
- **Default** — ветка по умолчанию

**Пример:**
```
Переменная: {{callback_data}}
Варианты:
  - "balance" → показать баланс
  - "history" → показать историю
  - "help" → показать справку
  - default → неизвестная команда
```

---

## Управление потоком

### Задержка (`flow.delay`)

Пауза перед выполнением следующего шага.

**Настройки:**
- **Секунды** — время задержки

**Примеры использования:**
- Имитация "печатания"
- Отложенные напоминания
- Последовательные сообщения

### Цикл (`flow.loop`)

Повторяет действия заданное количество раз.

**Настройки:**
- **Количество итераций**
- **Переменная счетчика**

### Подпроцесс (`flow.sub_workflow`)

Запускает другой workflow как часть текущего.

**Настройки:**
- **Workflow ID** — какой сценарий запустить
- **Параметры** — данные для передачи

### Переход (`flow.jump`)

Безусловный переход на другую ноду.

**Настройки:**
- **Target Node ID** — куда перейти

### Завершение (`flow.end`)

Завершает выполнение сценария.

**Настройки:**
- **Статус** — success, error, cancelled

---

## Интеграции

### Webhook (`integration.webhook`)

Отправляет данные на внешний URL.

**Настройки:**
- **URL** — адрес webhook
- **Метод** — POST, GET
- **Данные** — что отправить

### Аналитика (`integration.analytics`)

Отправляет событие в систему аналитики.

**Настройки:**
- **Событие** — название события
- **Параметры** — дополнительные данные

---

## Примеры сценариев

### Приветствие нового пользователя

```
[Триггер: /start]
    ↓
[Сообщение: "Добро пожаловать! Выберите действие:"]
    + Inline кнопки:
      - "Получить подарок" (callback: get_gift)
      - "Мой баланс" (callback: balance)
    ↓
[Триггер: Callback]
    ↓
[Условие: callback_data == "get_gift"]
    ├── true → [Сообщение: "Ваш подарок: 100 бонусов!"]
    └── false → [Действие: Получить баланс] → [Сообщение: "Ваш баланс: {{balance}}"]
```

### Регистрация с запросом телефона

```
[Триггер: /start]
    ↓
[Действие: Проверка связи]
    ↓
[Условие: isLinked == true]
    ├── true → [Сообщение: "С возвращением, {{user.firstName}}!"]
    └── false → [Сообщение: "Поделитесь контактом для регистрации"]
                    + Reply кнопка: "Поделиться контактом" (request_contact)
                    ↓
                [Действие: Запрос контакта]
                    ↓
                [Действие: Поиск по контакту]
                    ↓
                [Условие: userFound]
                    ├── true → [Действие: Привязать Telegram]
                    └── false → [Сообщение: "Пользователь не найден"]
```

---

## Советы

1. **Начинайте с простого** — создайте базовый сценарий и постепенно усложняйте
2. **Используйте переменные** — они делают сообщения персонализированными
3. **Тестируйте по частям** — проверяйте каждую ветку отдельно
4. **Добавляйте fallback** — обрабатывайте неожиданные ответы пользователей
5. **Документируйте** — давайте понятные названия нодам
