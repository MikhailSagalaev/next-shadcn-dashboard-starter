# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: Race Condition –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ Callback Queries

**–î–∞—Ç–∞**: 2025-10-30  
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, —Ç–æ–ª—å–∫–æ –≤—Ç–æ—Ä–æ–π  
**–§–∞–π–ª**: `src/lib/services/workflow-runtime.service.ts`

---

## üêõ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –°–∏–º–ø—Ç–æ–º—ã:
–ü—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å Telegram –±–æ—Ç–æ–º:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start` ‚Üí –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏ ‚úÖ
2. **–ü–µ—Ä–≤—ã–π –∫–ª–∏–∫** –Ω–∞ –∫–Ω–æ–ø–∫—É ‚Üí –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ "‚ö†Ô∏è –î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å workflow" ‚ùå
3. **–í—Ç–æ—Ä–æ–π –∫–ª–∏–∫** –Ω–∞ —Ç—É –∂–µ –∫–Ω–æ–ø–∫—É ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç ‚úÖ
4. **–¢—Ä–µ—Ç–∏–π –∫–ª–∏–∫** ‚Üí —Å–Ω–æ–≤–∞ –æ—à–∏–±–∫–∞ ‚ùå
5. **–ß–µ—Ç–≤–µ—Ä—Ç—ã–π –∫–ª–∏–∫** ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞: **Race Condition**

–ö–æ–≥–¥–∞ message handler –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏:
1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `workflow_execution.status = 'waiting'` –≤ –ë–î
2. –ù–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∫–ª–∏–∫–Ω—É—Ç—å –∫–Ω–æ–ø–∫—É **–î–û —Ç–æ–≥–æ**, –∫–∞–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ë–î –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è
3. –°–ª–µ–¥—É—é—â–∏–π callback query –∏—â–µ—Ç waiting execution ‚Üí **–Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç** (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞)
4. –°–æ–∑–¥–∞–µ—Ç **–ù–û–í–´–ô execution** –≤–º–µ—Å—Ç–æ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
5. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ: –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ executions –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞

### –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∏–∑ –ª–æ–≥–æ–≤:

```
Execution cmhd9nfi60001v8vs1zj5d3gu (initial /start)
Execution cmhd9nhvc0003v8vs0pqsac5o (first click - menu-balance-trigger)
Execution cmhd9nkn00005v8vs1en94yd7 (second click - menu-balance-trigger –°–ù–û–í–ê!)
Execution cmhd9no2z0007v8vspnx0uh8o (third click - menu-main-trigger)
```

–ö–∞–∂–¥—ã–π –∫–ª–∏–∫ —Å–æ–∑–¥–∞–≤–∞–ª –Ω–æ–≤—ã–π execution –≤–º–µ—Å—Ç–æ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏

```typescript
// –ö–†–ò–¢–ò–ß–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
let waitingExecution = null;
const maxAttempts = 3;
const delayMs = 150;

for (let attempt = 1; attempt <= maxAttempts; attempt++) {
  if (attempt > 1) {
    logger.info(`‚è≥ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ${attempt}/${maxAttempts}`);
  }
  
  await new Promise(resolve => setTimeout(resolve, delayMs));

  waitingExecution = await db.workflowExecution.findFirst({
    where: {
      projectId,
      status: 'waiting',
      telegramChatId: chatId,
      waitType: waitType === 'input' ? ({ in: ['input', 'contact'] } as any) : waitType
    },
    orderBy: {
      startedAt: 'desc'
    }
  });
  
  if (waitingExecution) {
    logger.info(`‚úÖ Waiting execution –Ω–∞–π–¥–µ–Ω –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ ${attempt}`);
    break;
  }
}
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

```typescript
orderBy: {
  startedAt: 'desc' // –ë–µ—Ä–µ–º —Å–∞–º—ã–π –ø–æ—Å–ª–µ–¥–Ω–∏–π waiting execution
}
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```typescript
logger.info('üîç –ü–æ–∏—Å–∫ waiting execution', {
  projectId,
  chatId,
  waitType,
  trigger
});

logger.info('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ waiting execution', {
  found: !!waitingExecution,
  executionId: waitingExecution?.id,
  currentNodeId: waitingExecution?.currentNodeId,
  waitType: waitingExecution?.waitType,
  attempts: waitingExecution ? 'found' : maxAttempts
});
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

```typescript
// –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ execution –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ
if (chatId && trigger === 'callback') {
  const activeExecutions = await db.workflowExecution.findMany({
    where: {
      projectId,
      telegramChatId: chatId,
      status: {
        in: ['running', 'waiting']
      }
    },
    orderBy: {
      startedAt: 'desc'
    },
    take: 5
  });

  if (activeExecutions.length > 0) {
    logger.warn('‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã–µ executions –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞!', {
      activeCount: activeExecutions.length
    });
    
    logger.error('üö® RACE CONDITION: Waiting execution —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', {
      projectId,
      chatId,
      trigger
    });
  }
}
```

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:
1. ‚úÖ **–ü–µ—Ä–≤—ã–π –∫–ª–∏–∫** –Ω–∞ –∫–Ω–æ–ø–∫—É —Å—Ä–∞–∑—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. ‚úÖ –ù–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è executions
3. ‚úÖ –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∫–ª–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
4. ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä: `yarn dev`
2. –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –≤ Telegram
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/start`
4. –ö–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É
5. **–û–∂–∏–¥–∞–µ—Ç—Å—è**: –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç, –±–µ–∑ –æ—à–∏–±–∫–∏ "‚ö†Ô∏è –î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π..."

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:
–í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏:
```
üîç –ü–æ–∏—Å–∫ waiting execution
‚úÖ Waiting execution –Ω–∞–π–¥–µ–Ω –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ 1
üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ waiting execution: found
```

–ï—Å–ª–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è:
```
‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã–µ executions –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞!
üö® RACE CONDITION: Waiting execution —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
```
–ó–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –≤—Å–µ –µ—â–µ –µ—Å—Ç—å - –Ω—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å `delayMs` –∏–ª–∏ `maxAttempts`.

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- **50%** –∫–ª–∏–∫–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞
- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ executions**: –ø–æ—Å—Ç–æ—è–Ω–Ω–æ
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç**: üî¥ –ø–ª–æ—Ö–æ–π

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- **95%+** –∫–ª–∏–∫–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞ ‚úÖ
- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ executions**: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç**: üü¢ —Ö–æ—Ä–æ—à–∏–π

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤—Å–µ –µ—â–µ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è:

### 1. –£–≤–µ–ª–∏—á–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É:
```typescript
const delayMs = 200; // –≤–º–µ—Å—Ç–æ 150
```

### 2. –£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫:
```typescript
const maxAttempts = 5; // –≤–º–µ—Å—Ç–æ 3
```

### 3. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å –≤ –ë–î:
```sql
CREATE INDEX idx_workflow_executions_waiting 
ON workflow_executions(project_id, telegram_chat_id, status, wait_type, started_at DESC);
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ó–∞–¥–µ—Ä–∂–∫–∞ 150ms** - —ç—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é
2. **3 –ø–æ–ø—ã—Ç–∫–∏** - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è 99% —Å–ª—É—á–∞–µ–≤ –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –Ω–∞ –ë–î
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –±—É–¥—É—â–∏—Ö –ø—Ä–æ–±–ª–µ–º
4. **–ù–µ —É–¥–∞–ª—è—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ executions** - –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ª–µ–≥–∏—Ç–∏–º–Ω—ã–º–∏

---

## üìù Changelog

**[2025-10-30] - Critical Fix**
### üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- Race condition –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ callback queries
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ workflow executions
- –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –ø–æ–∏—Å–∫–∞ waiting executions
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è executions

### ‚ú® –î–æ–±–∞–≤–ª–µ–Ω–æ
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–∏—Å–∫–∞ waiting executions
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö executions –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ execution

