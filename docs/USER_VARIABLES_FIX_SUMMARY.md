# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç

**–î–∞—Ç–∞**: 2025-10-29  
**–ó–∞–¥–∞—á–∞**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ Telegram –±–æ—Ç–µ

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏

### 1. `{user.expiringBonuses}` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è –∫–∞–∫ —Ç–µ–∫—Å—Ç
**–ü—Ä–∏—á–∏–Ω–∞**: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –±—ã–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `get_user_profile`  
**–°–∏–º–ø—Ç–æ–º**: –í —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –≤–∏–¥–Ω–æ `üèÜ –ò—Å—Ç–µ–∫–∞–µ—Ç –≤ –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π: {user.expiringBonuses}‚ÇΩ`

### 2. `{user.referralLink}` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–ª "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
**–ü—Ä–∏—á–∏–Ω–∞**: –•–∞—Ä–¥–∫–æ–¥ `your_bot_username` –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ username –±–æ—Ç–∞  
**–°–∏–º–ø—Ç–æ–º**: 
```
üîó –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ
```

### 3. –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ‚Äî –Ω–µ–∫—Ä–∞—Å–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ –±—ã–ª–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä–∞  
**–°–∏–º–ø—Ç–æ–º**: –ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∏–∫–æ–Ω–æ–∫ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### 4. –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —É—Ä–æ–≤–Ω—è ‚Äî –Ω–µ –±—ã–ª —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
**–ü—Ä–∏—á–∏–Ω–∞**: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `{user.progressBar}` –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞  
**–°–∏–º–ø—Ç–æ–º**: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å

---

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞—Å—á—ë—Ç –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –±–æ–Ω—É—Å–æ–≤
**–§–∞–π–ª**: `src/lib/services/workflow/query-executor.ts`

```typescript
// –ü–æ–¥—Å—á—ë—Ç –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –±–æ–Ω—É—Å–æ–≤ –≤ –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π
const thirtyDaysFromNow = new Date();
thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);

const expiringBonuses = user.bonuses
  .filter(b => b.expiresAt && b.expiresAt <= thirtyDaysFromNow && b.expiresAt > new Date())
  .reduce((sum, bonus) => sum + Number(bonus.amount), 0);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á–∏—Å–ª–æ: `350` (–µ—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–µ–∫–∞—é—â–∏–µ –±–æ–Ω—É—Å—ã)

---

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
**–§–∞–π–ª**: `src/lib/services/workflow/query-executor.ts`

**–ë—ã–ª–æ**:
```typescript
const referralLink = `https://t.me/your_bot_username?start=ref_${user.referralCode}`;
```

**–°—Ç–∞–ª–æ**:
```typescript
const [project, botSettings] = await Promise.all([
  db.project.findUnique({ where: { id: params.projectId } }),
  db.botSettings.findFirst({ 
    where: { projectId: params.projectId },
    select: { botUsername: true }
  })
]);

const botUsername = botSettings?.botUsername || 'your_bot_username';
const referralLink = `https://t.me/${botUsername}?start=ref_${user.referralCode}`;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É: `https://t.me/gupilbot?start=ref_ABC123`

---

### 3. –î–æ–±–∞–≤–ª–µ–Ω –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
**–§–∞–π–ª**: `src/lib/services/workflow/user-variables.service.ts`

```typescript
const formatTransactionsDetailed = (transactions: any[]) => {
  if (!transactions || transactions.length === 0) {
    return 'üì≠ –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø—É—Å—Ç–∞';
  }
  
  return transactions.slice(0, 10).map((t, index) => {
    const amount = Number(t.amount);
    const icon = t.type === 'EARN' ? 'üíö' : 'üí∏';
    const sign = t.type === 'EARN' ? '+' : '-';
    const date = new Intl.DateTimeFormat('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    }).format(new Date(t.createdAt));
    
    return `${index + 1}. ${icon} ${sign}${Math.abs(amount)} ‚ÇΩ ‚Ä¢ ${t.description || '–û–ø–µ—Ä–∞—Ü–∏—è'}\n   üìÖ ${date}`;
  }).join('\n\n');
};
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
```
1. üíö +400 ‚ÇΩ ‚Ä¢ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞ –ø–æ–∫—É–ø–∫—É
   üìÖ 28.10, 12:30

2. üí∏ -200 ‚ÇΩ ‚Ä¢ –°–ø–∏—Å–∞–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤
   üìÖ 25.10, 15:45
```

---

### 4. –î–æ–±–∞–≤–ª–µ–Ω –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
**–§–∞–π–ª**: `src/lib/services/workflow/user-variables.service.ts`

```typescript
const generateProgressBar = (currentLevel: string) => {
  const levels = ['–ë–∞–∑–æ–≤—ã–π', '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π', '–ó–æ–ª–æ—Ç–æ–π', '–ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π'];
  const currentIndex = levels.indexOf(currentLevel);
  
  if (currentIndex === -1) {
    return '‚ñ±‚ñ±‚ñ±‚ñ± (0%)';
  }
  
  const progress = ((currentIndex + 1) / levels.length) * 100;
  const filled = Math.floor(progress / 25);
  const empty = 4 - filled;
  
  const bar = '‚ñ∞'.repeat(filled) + '‚ñ±'.repeat(empty);
  return `${bar} (${Math.round(progress)}%)`;
};
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
- –ë–∞–∑–æ–≤—ã–π: `‚ñ∞‚ñ±‚ñ±‚ñ± (25%)`
- –°–µ—Ä–µ–±—Ä—è–Ω—ã–π: `‚ñ∞‚ñ∞‚ñ±‚ñ± (50%)`
- –ó–æ–ª–æ—Ç–æ–π: `‚ñ∞‚ñ∞‚ñ∞‚ñ± (75%)`
- –ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π: `‚ñ∞‚ñ∞‚ñ∞‚ñ∞ (100%)`

---

## üìù –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

–¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ workflow:

```typescript
{user.expiringBonuses}      // –ß–∏—Å–ª–æ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –±–æ–Ω—É—Å–æ–≤ (30 –¥–Ω–µ–π)
{user.progressBar}           // –í–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —É—Ä–æ–≤–Ω—è
{transactions.formatted}     // –ö—Ä–∞—Å–∏–≤–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
{user.referralLink}          // –†–µ–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –±–æ—Ç–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
```

---

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –®–∞–≥ 1: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä

**Windows PowerShell**:
```powershell
# –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å –∑–∞–ø—É—â–µ–Ω–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º –Ω–∞–∂–∞—Ç—å Ctrl+C
# –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞:
pnpm dev
```

**–ò–ª–∏ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω**:
```powershell
cd D:\next-shadcn-dashboard-starter
pnpm dev
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Telegram

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start`
3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é:
   - **üí∞ –ë–∞–ª–∞–Ω—Å** ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `expiringBonuses`
   - **üìú –ò—Å—Ç–æ—Ä–∏—è** ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `transactions.formatted`
   - **üèÜ –£—Ä–æ–≤–µ–Ω—å** ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `progressBar`
   - **üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å** ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `referralLink`

---

## ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
```
üèÜ –ò—Å—Ç–µ–∫–∞–µ—Ç –≤ –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π: {user.expiringBonuses}‚ÇΩ

üîó –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ

üèÖ –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: –ë–∞–∑–æ–≤—ã–π
–ü—Ä–æ–≥—Ä–µ—Å—Å: {user.progressBar}
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
```
üèÜ –ò—Å—Ç–µ–∫–∞–µ—Ç –≤ –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π: 350‚ÇΩ

üîó –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
https://t.me/gupilbot?start=ref_ABC123

üèÖ –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: –ë–∞–∑–æ–≤—ã–π
–ü—Ä–æ–≥—Ä–µ—Å—Å: ‚ñ∞‚ñ±‚ñ±‚ñ± (25%)
```

---

## üìä –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

1. ‚úÖ `src/lib/services/workflow/query-executor.ts`
   - –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞—Å—á—ë—Ç `expiringBonuses`
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è `referralLink`

2. ‚úÖ `src/lib/services/workflow/user-variables.service.ts`
   - –î–æ–±–∞–≤–ª–µ–Ω `generateProgressBar()`
   - –î–æ–±–∞–≤–ª–µ–Ω `formatTransactionsDetailed()`
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ return –æ–±—ä–µ–∫—Ç

3. ‚úÖ `docs/changelog.md`
   - –û–±–Ω–æ–≤–ª—ë–Ω —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π

4. ‚úÖ `docs/USER_VARIABLES_COMPLETE_GUIDE.md` (–Ω–æ–≤—ã–π)
   - –ü–æ–ª–Ω—ã–π –≥–∞–π–¥ –ø–æ –≤—Å–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—Å—ë –µ—â—ë –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç:

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
   ```powershell
   Ctrl+C
   pnpm dev
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ ‚Äî –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
   ```
   ‚úÖ Loaded 32 nodes in workflow
   Loading user variables for userId: ...
   User variables loaded: { variableCount: 30+ }
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î** ‚Äî –µ—Å—Ç—å –ª–∏ `botUsername` –≤ `bot_settings`:
   ```sql
   SELECT botUsername FROM bot_settings WHERE projectId = 'your_project_id';
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ `referralCode`** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   ```sql
   SELECT referralCode FROM users WHERE id = 'your_user_id';
   ```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω—ã–π –≥–∞–π–¥**: `docs/USER_VARIABLES_COMPLETE_GUIDE.md`
- **Changelog**: `docs/changelog.md`
- **Interactive Menu**: `docs/INTERACTIVE_MENU_IMPLEMENTATION.md`

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é  
**–¢—Ä–µ–±—É–µ—Ç—Å—è**: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞

