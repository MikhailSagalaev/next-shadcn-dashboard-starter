# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –æ–∂–∏–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ workflow

**–î–∞—Ç–∞:** 2025-10-21  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–æ–¥–∞ `action.database_query` "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç—É/email" –Ω–µ –∂–¥–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞  
**–†–µ—à–µ–Ω–∏–µ:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ö–∞–Ω–∏–∑–º waiting states —Å –Ω–æ–≤–æ–π –Ω–æ–¥–æ–π `action.request_contact`

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–°—Ü–µ–Ω–∞—Ä–∏–π –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
1. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º –∫–æ–Ω—Ç–∞–∫—Ç–∞
2. –ù–æ–¥–∞ `action.database_query` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É
3. **–ü—Ä–æ–±–ª–µ–º–∞:** Workflow —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –∫–æ–Ω—Ç–∞–∫—Ç–∞
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≤—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 1Ô∏è‚É£ –ù–æ–≤–∞—è –Ω–æ–¥–∞ `action.request_contact`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç workflow –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞

**–§–∞–π–ª—ã:**
- `src/lib/services/workflow/handlers/action-handlers.ts` - `RequestContactHandler`
- `src/features/workflow/components/nodes/contact-request-node.tsx` - UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- `src/features/workflow/components/workflow-toolbar.tsx` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Ç—É–ª–±–∞—Ä
- `src/features/workflow/components/nodes/workflow-node-types.tsx` - –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Ç–∏–ø

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
```typescript
// 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å execution –≤ 'waiting'
await db.workflowExecution.update({
  where: { id: context.executionId },
  data: {
    status: 'waiting',
    waitType: 'contact',
    currentNodeId: node.id
  }
});

// 2. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
return '__WAITING_FOR_CONTACT__';
```

---

### 2Ô∏è‚É£ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤

**–§–∞–π–ª:** `src/lib/services/bot-flow-executor/router-integration.ts`

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `handleContact`:**
```typescript
// 1. –ò—â–µ—Ç workflow –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting
const waitingExecution = await db.workflowExecution.findFirst({
  where: {
    projectId: this.projectId,
    telegramChatId: chatId,
    status: 'waiting',
    waitType: 'contact'
  }
});

// 2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
const user = await db.user.upsert({
  where: { telegramId_projectId: { telegramId: BigInt(userId), projectId: this.projectId } },
  update: { phone: contact.phone_number, ... },
  create: { telegramId: BigInt(userId), projectId: this.projectId, phone: contact.phone_number, ... }
});

// 3. –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç workflow
await processor.resumeWorkflow(context, nextNodeId);
```

---

### 3Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SimpleWorkflowProcessor

**–§–∞–π–ª:** `src/lib/services/simple-workflow-processor.ts`

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `resumeWorkflow`:**
```typescript
async resumeWorkflow(context: ExecutionContext, startNodeId: string): Promise<void> {
  return this.executeWorkflow(context, startNodeId);
}
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞:**
```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞
if (nextNodeId === '__WAITING_FOR_CONTACT__') {
  logger.info('‚è∏Ô∏è Workflow paused waiting for contact', {
    executionId: context.executionId,
    nodeId: currentNodeId
  });
  // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ - workflow –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting
  return;
}
```

---

### 4Ô∏è‚É£ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π workflow

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
–°–æ–æ–±—â–µ–Ω–∏–µ ‚Üí action.database_query ‚Üí –°–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚ùå
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
–°–æ–æ–±—â–µ–Ω–∏–µ ‚Üí action.request_contact ‚Üí [–û–ñ–ò–î–ê–ù–ò–ï –ö–û–ù–¢–ê–ö–¢–ê] ‚Üí –°–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚úÖ
```

---

## üé® UI/UX —É–ª—É—á—à–µ–Ω–∏—è

### –ù–æ–≤–∞—è –Ω–æ–¥–∞ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ
- **–ò–∫–æ–Ω–∫–∞:** Phone (üìû)
- **–¶–≤–µ—Ç:** Emerald (#10B981)
- **–ù–∞–∑–≤–∞–Ω–∏–µ:** "–ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ç–∞–∫—Ç–∞"
- **–û–ø–∏—Å–∞–Ω–∏–µ:** "–ñ–¥—ë—Ç –∫–æ–Ω—Ç–∞–∫—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ
- Workflow –≤–∏–∑—É–∞–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–¥–µ `action.request_contact`
- –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: "‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç –ø–æ–ª—É—á–µ–Ω!"

---

## üìä –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã
1. `src/features/workflow/components/nodes/contact-request-node.tsx` - UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–æ–¥—ã

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
1. `src/lib/services/workflow/handlers/action-handlers.ts` - –Ω–æ–≤—ã–π handler
2. `src/lib/services/workflow/handlers/index.ts` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è handler
3. `src/lib/services/simple-workflow-processor.ts` - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ waiting states
4. `src/lib/services/bot-flow-executor/router-integration.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
5. `src/types/workflow.ts` - –Ω–æ–≤—ã–π —Ç–∏–ø –Ω–æ–¥—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
6. `src/features/workflow/components/workflow-toolbar.tsx` - –Ω–æ–¥–∞ –≤ —Ç—É–ª–±–∞—Ä–µ
7. `src/features/workflow/components/nodes/workflow-node-types.tsx` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è workflow execution
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∫ –ø—Ä–æ–µ–∫—Ç—É
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ waiting
- ‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–∞

### –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞
- ‚úÖ TTL –¥–ª—è waiting —Å–æ—Å—Ç–æ—è–Ω–∏–π (–≤ resumeData)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ telegram chat ID
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å workflow: –°–æ–æ–±—â–µ–Ω–∏–µ ‚Üí action.request_contact ‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ
2. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å workflow –∫–æ–º–∞–Ω–¥–æ–π `/start`
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ workflow –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è (—Å—Ç–∞—Ç—É—Å 'waiting')
5. ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç —á–µ—Ä–µ–∑ Telegram
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–æ–Ω—Ç–∞–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î
7. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ workflow –ø—Ä–æ–¥–æ–ª–∂–∏–ª—Å—è –∏ –æ—Ç–ø—Ä–∞–≤–∏–ª –≤—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
```
‚è∏Ô∏è Workflow paused waiting for contact { executionId, nodeId }
üìû Contact received { userId, phoneNumber }
‚úÖ Contact received and user linked { userId }
Resuming workflow after contact { executionId, nextNodeId }
```

---

## üìù –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ

### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–¥—É "–ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ç–∞–∫—Ç–∞"
1. –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä workflow
2. –ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å –Ω–æ–¥—É "–ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ç–∞–∫—Ç–∞" (üìû) –Ω–∞ —Ö–æ–ª—Å—Ç
3. –°–æ–µ–¥–∏–Ω–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é –Ω–æ–¥—É —Å —ç—Ç–æ–π

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
```
–¢—Ä–∏–≥–≥–µ—Ä ‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º ‚Üí –ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ç–∞–∫—Ç–∞ ‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è
```

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å workflow
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ workflow

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!** ‚úÖ

–¢–µ–ø–µ—Ä—å workflow –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏, —Ç—Ä–µ–±—É—é—â–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞:

- ‚úÖ Workflow –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏ –∂–¥–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–∞
- ‚úÖ –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
- ‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

---

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –£–ª—É—á—à–µ–Ω–∏—è UI
- [ ] –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è waiting —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ
- [ ] –ü—Ä–µ–≤—å—é workflow —Å –æ—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏
- [ ] –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è waiting —Å–æ—Å—Ç–æ—è–Ω–∏–π

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∏–ø—ã waiting
- [ ] –û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (`action.request_text`)
- [ ] –û–∂–∏–¥–∞–Ω–∏–µ callback (`action.request_callback`)
- [ ] –û–∂–∏–¥–∞–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ (`action.request_location`)

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
- [ ] –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- [ ] –¢–∞–π–º–∞—É—Ç—ã —Å fallback –¥–µ–π—Å—Ç–≤–∏—è–º–∏

