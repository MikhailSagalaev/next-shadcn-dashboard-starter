# –ê–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç—ã appliedBonuses

## üìã –û–±–∑–æ—Ä

`appliedBonuses` - —ç—Ç–æ –∫–ª—é—á–µ–≤–æ–µ –ø–æ–ª–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø–µ—Ä–µ–¥–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤ –∏–∑ –≤–∏–¥–∂–µ—Ç–∞ Tilda –≤ backend —á–µ—Ä–µ–∑ webhook.

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª appliedBonuses

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)

```javascript
// –í–∏–¥–∂–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç state
state: {
  appliedBonuses: 0,  // –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  // ...
}

// –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ localStorage
loadUserDataFromStorage: function() {
  const savedAppliedBonuses = localStorage.getItem('tilda_applied_bonuses');
  if (savedAppliedBonuses) {
    const bonusAmount = parseFloat(savedAppliedBonuses);
    if (!isNaN(bonusAmount) && bonusAmount >= 0 && bonusAmount <= 10000) {
      this.state.appliedBonuses = bonusAmount;
    }
  }
}
```

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ #1**: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–º–µ–Ω–∏–ª –±–æ–Ω—É—Å—ã, –Ω–æ –Ω–µ –æ—Ñ–æ—Ä–º–∏–ª –∑–∞–∫–∞–∑, –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ localStorage –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∑–∞–∫–∞–∑—É.

### 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ (–∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ü—Ä–∏–º–µ–Ω–∏—Ç—å")

```javascript
applyBonuses: function(amount) {
  // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ state
  this.state.appliedBonuses = amount;
  
  // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
  localStorage.setItem('tilda_applied_bonuses', amount);
  
  // 3. –î–æ–±–∞–≤–ª—è–µ–º –≤–æ –í–°–ï –≤–æ–∑–º–æ–∂–Ω—ã–µ –º–µ—Å—Ç–∞ –≤ window.tcart
  window.tcart.appliedBonuses = String(amount);
  window.tcart.data.appliedBonuses = String(amount);
  window.tcart.formData.appliedBonuses = String(amount);
  window.tcart.order.appliedBonuses = String(amount);
  window.tcart.orderData.appliedBonuses = String(amount);
  
  // 4. –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –≤ —Ñ–æ—Ä–º—É
  this.addHiddenBonusField(amount);
  
  // 5. –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ "GUPIL" —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∫–∏–¥–∫–æ–π
  window.t_input_promocode__addPromocode({
    promocode: 'GUPIL',
    discountsum: amount
  });
}
```

**–ú–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞—â–∏—Ç—ã**:
- –ü–µ—Ä–µ—Ö–≤–∞—Ç `JSON.stringify` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è `appliedBonuses` –≤ JSON –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è (—á–µ—Ä–µ–∑ 100ms, 500ms, 1000ms)
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ backup –ø–æ–ª—è –≤ `document.body`

### 3. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞

```javascript
// –ü–µ—Ä–µ—Ö–≤–∞—Ç JSON.stringify
window.JSON.stringify = function(value, replacer, space) {
  // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–∫–∞–∑ Tilda (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ payment –∏ formname)
  if (isTildaOrder && self.state.appliedBonuses > 0) {
    // –î–æ–±–∞–≤–ª—è–µ–º appliedBonuses –≤ –æ–±—ä–µ–∫—Ç
    modifiedValue = {
      ...value,
      appliedBonuses: String(self.state.appliedBonuses)
    };
    return originalStringify.call(this, modifiedValue, replacer, space);
  }
};
```

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ backend

```typescript
// TildaParserService.normalizeOrder()
let appliedBonuses = 0;
const candidates = [
  out.appliedBonuses,
  out.applied_bonuses,
  out.AppliedBonuses,
  out['appliedBonuses']
];

for (const val of candidates) {
  if (val !== undefined && val !== null) {
    if (typeof val === 'number') {
      appliedBonuses = val;
    } else {
      const parsed = parseFloat(String(val).replace(/[^0-9.]/g, ''));
      if (!isNaN(parsed)) appliedBonuses = parsed;
    }
    break;
  }
}
```

### 5. –°–ø–∏—Å–∞–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤

```typescript
// OrderProcessingService.processOrder()
const appliedRequested = order.appliedBonuses;

const shouldSpend =
  appliedRequested > 0 &&
  (bonusBehavior === 'SPEND_AND_EARN' || bonusBehavior === 'SPEND_ONLY');

if (shouldSpend) {
  const balance = await UserService.getUserBalance(user.id);
  const canSpend = Math.min(
    appliedRequested,
    Number(balance.currentBalance),
    totalAmount
  );

  if (canSpend > 0) {
    const transactions = await BonusService.spendBonuses(
      user.id,
      canSpend,
      `Order ${order.orderId}`,
      { orderId: order.orderId, source: 'tilda' }
    );
    spentAmount = transactions.reduce((sum, t) => sum + Number(t.amount), 0);
    actuallySpent = true;
  }
}
```

## üêõ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏

### –ë–∞–≥ #1: –ü—Ä–∏–º–µ–Ω–∏–ª –±–æ–Ω—É—Å—ã, –Ω–æ –Ω–µ –æ—Ñ–æ—Ä–º–∏–ª –∑–∞–∫–∞–∑

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–º–µ–Ω—è–µ—Ç 500 –±–æ–Ω—É—Å–æ–≤
2. –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –∫–æ—Ä–∑–∏–Ω—É –±–µ–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
3. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–æ—Ä–∑–∏–Ω—É —Å–Ω–æ–≤–∞

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- `appliedBonuses` –æ—Å—Ç–∞–µ—Ç—Å—è –≤ `localStorage` = 500
- –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–∂–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ
- –ü—Ä–æ–º–æ–∫–æ–¥ "GUPIL" –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –ù–ï –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ë–æ–Ω—É—Å—ã "–≤–∏—Å—è—Ç" –≤ state, –Ω–æ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ –∫–æ—Ä–∑–∏–Ω–µ

**–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
```javascript
// –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã –≤–∏–¥–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç appliedBonuses
observeCart: function() {
  // –ï—Å–ª–∏ –µ—Å—Ç—å appliedBonuses > 0, –ø–µ—Ä–µ–ø—Ä–∏–º–µ–Ω—è–µ–º
  if (this.state.appliedBonuses > 0) {
    this.reapplyBonuses();
  }
}
```

### –ë–∞–≥ #2: –ü—Ä–∏–º–µ–Ω–∏–ª –±–æ–Ω—É—Å—ã, –∏–∑–º–µ–Ω–∏–ª —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. –ö–æ—Ä–∑–∏–Ω–∞: 5000‚ÇΩ, –ø—Ä–∏–º–µ–Ω–∏–ª 1000 –±–æ–Ω—É—Å–æ–≤
2. –î–æ–±–∞–≤–∏–ª –µ—â–µ —Ç–æ–≤–∞—Ä –Ω–∞ 2000‚ÇΩ (–∏—Ç–æ–≥–æ 7000‚ÇΩ)
3. –û—Ñ–æ—Ä–º–ª—è–µ—Ç –∑–∞–∫–∞–∑

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- `appliedBonuses` = 1000 (–Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)
- –°—É–º–º–∞ –∫–æ—Ä–∑–∏–Ω—ã = 7000‚ÇΩ
- –ü—Ä–æ–º–æ–∫–æ–¥ "GUPIL" —Å discountsum=1000 –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –Ω–æ–≤–æ–π —Å—É–º–º–µ
- –ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: 6000‚ÇΩ

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - –±–æ–Ω—É—Å—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –Ω–æ–≤–æ–π —Å—É–º–º–µ

### –ë–∞–≥ #3: –ü—Ä–∏–º–µ–Ω–∏–ª –±–æ–Ω—É—Å—ã, —É–±—Ä–∞–ª —Ç–æ–≤–∞—Ä—ã (—Å—É–º–º–∞ < appliedBonuses)

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. –ö–æ—Ä–∑–∏–Ω–∞: 5000‚ÇΩ, –ø—Ä–∏–º–µ–Ω–∏–ª 3000 –±–æ–Ω—É—Å–æ–≤
2. –£–¥–∞–ª–∏–ª —Ç–æ–≤–∞—Ä—ã, –æ—Å—Ç–∞–ª–æ—Å—å 2000‚ÇΩ
3. –û—Ñ–æ—Ä–º–ª—è–µ—Ç –∑–∞–∫–∞–∑

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- `appliedBonuses` = 3000 (–±–æ–ª—å—à–µ —Å—É–º–º—ã –∫–æ—Ä–∑–∏–Ω—ã!)
- Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: `canSpend = Math.min(appliedRequested, balance, totalAmount)`
- `canSpend = Math.min(3000, balance, 2000) = 2000`
- –°–ø–∏—à–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 2000 –±–æ–Ω—É—Å–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - backend –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–µ—Ä–µ–ø–ª–∞—Ç—ã

### –ë–∞–≥ #4: –ü—Ä–∏–º–µ–Ω–∏–ª –±–æ–Ω—É—Å—ã, –∑–∞–∫—Ä—ã–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É, –≤–µ—Ä–Ω—É–ª—Å—è —á–µ—Ä–µ–∑ –¥–µ–Ω—å

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. –ü—Ä–∏–º–µ–Ω–∏–ª 1000 –±–æ–Ω—É—Å–æ–≤
2. –ó–∞–∫—Ä—ã–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É
3. –ß–µ—Ä–µ–∑ –¥–µ–Ω—å –≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞ —Å–∞–π—Ç
4. –û—Ç–∫—Ä—ã–ª –∫–æ—Ä–∑–∏–Ω—É

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- `localStorage.getItem('tilda_applied_bonuses')` = "1000"
- –í–∏–¥–∂–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `state.appliedBonuses = 1000`
- –ù–û –∫–æ—Ä–∑–∏–Ω–∞ Tilda –º–æ–≥–ª–∞ –±—ã—Ç—å –æ—á–∏—â–µ–Ω–∞
- –ü—Ä–æ–º–æ–∫–æ–¥ –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–æ—Ä–∑–∏–Ω—ã
```javascript
loadUserDataFromStorage: function() {
  const savedAppliedBonuses = localStorage.getItem('tilda_applied_bonuses');
  
  // –î–û–ë–ê–í–ò–¢–¨: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ—Ä–∑–∏–Ω–∞ –Ω–µ –ø—É—Å—Ç–∞—è
  if (savedAppliedBonuses && this.getCartTotal() > 0) {
    const bonusAmount = parseFloat(savedAppliedBonuses);
    if (!isNaN(bonusAmount) && bonusAmount >= 0 && bonusAmount <= 10000) {
      this.state.appliedBonuses = bonusAmount;
      // –ü–µ—Ä–µ–ø—Ä–∏–º–µ–Ω—è–µ–º –±–æ–Ω—É—Å—ã –∫ —Ç–µ–∫—É—â–µ–π –∫–æ—Ä–∑–∏–Ω–µ
      this.reapplyBonuses();
    }
  } else {
    // –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è - –æ—á–∏—â–∞–µ–º appliedBonuses
    this.resetAppliedBonuses();
  }
}
```

### –ë–∞–≥ #5: –ü—Ä–∏–º–µ–Ω–∏–ª –±–æ–Ω—É—Å—ã, –Ω–∞–∂–∞–ª "–ù–∞–∑–∞–¥" –≤ –±—Ä–∞—É–∑–µ—Ä–µ

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. –ü—Ä–∏–º–µ–Ω–∏–ª 1000 –±–æ–Ω—É—Å–æ–≤
2. –ù–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. –í–µ—Ä–Ω—É–ª—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –∫–æ—Ä–∑–∏–Ω–æ–π

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- `localStorage` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `appliedBonuses = 1000`
- –í–∏–¥–∂–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ
- –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ localStorage
- –ù–û –ø—Ä–æ–º–æ–∫–æ–¥ –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

**–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û —á–µ—Ä–µ–∑ `observeCart()`

### –ë–∞–≥ #6: –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –±–æ–Ω—É—Å—ã"

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. –ë—ã—Å—Ç—Ä–æ –∫–ª–∏–∫–∞–µ—Ç 2 —Ä–∞–∑–∞ –Ω–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å 1000 –±–æ–Ω—É—Å–æ–≤"

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫: `appliedBonuses = 1000`, –ø—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
- –í—Ç–æ—Ä–æ–π –∫–ª–∏–∫: `appliedBonuses = 1000` (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–µ–º –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ–º)
- –ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è

### –ë–∞–≥ #7: –ü—Ä–∏–º–µ–Ω–∏–ª –±–æ–Ω—É—Å—ã, –æ—á–∏—Å—Ç–∏–ª localStorage –≤—Ä—É—á–Ω—É—é

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. –ü—Ä–∏–º–µ–Ω–∏–ª 1000 –±–æ–Ω—É—Å–æ–≤
2. –û—Ç–∫—Ä—ã–ª DevTools –∏ –æ—á–∏—Å—Ç–∏–ª localStorage
3. –û—Ñ–æ—Ä–º–ª—è–µ—Ç –∑–∞–∫–∞–∑

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- `localStorage.getItem('tilda_applied_bonuses')` = null
- –ù–û `state.appliedBonuses` = 1000 (–≤ –ø–∞–º—è—Ç–∏)
- –ü—Ä–æ–º–æ–∫–æ–¥ "GUPIL" –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ –∫–æ—Ä–∑–∏–Ω–µ
- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ `appliedBonuses` –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ñ–æ—Ä–º—É
- –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ `appliedBonuses` –ø–æ–ø–∞–¥–µ—Ç –≤ webhook

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - state –≤ –ø–∞–º—è—Ç–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

### –ë–∞–≥ #8: –ü—Ä–∏–º–µ–Ω–∏–ª –±–æ–Ω—É—Å—ã, Tilda –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞–ª–∞ —Ñ–æ—Ä–º—É

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. –ü—Ä–∏–º–µ–Ω–∏–ª 1000 –±–æ–Ω—É—Å–æ–≤
2. Tilda –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞–ª–∞ —Ñ–æ—Ä–º—É –∫–æ—Ä–∑–∏–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏)
3. –û—Ñ–æ—Ä–º–ª—è–µ—Ç –∑–∞–∫–∞–∑

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ `appliedBonuses` —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ
- –ù–û –≤–∏–¥–∂–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—è
- –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ —Å–Ω–æ–≤–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - –µ—Å—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

```javascript
// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è
const updateAppliedBonusesField = () => {
  if (self.state.appliedBonuses > 0) {
    const fields = document.querySelectorAll('[name="appliedBonuses"]');
    if (fields.length === 0) {
      self.addHiddenBonusField(self.state.appliedBonuses);
    }
  }
};
```

## ‚úÖ –í—ã–≤–æ–¥—ã

### –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
1. ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ –∫ –∫–æ—Ä–∑–∏–Ω–µ
2. ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–ª–∞—Ç—ã –Ω–∞ backend
3. ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ —Ñ–æ—Ä–º—ã
4. ‚úÖ –ü–µ—Ä–µ—Ö–≤–∞—Ç JSON.stringify –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
5. ‚úÖ –ü–µ—Ä–µ–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã
6. ‚úÖ **–í–ù–ï–î–†–ï–ù–û: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω–µ**
7. ‚úÖ **–í–ù–ï–î–†–ï–ù–û: –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ**
8. ‚úÖ **–í–ù–ï–î–†–ï–ù–û: –ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ —Å—É–º–º—ã –∫–æ—Ä–∑–∏–Ω—ã**
9. ‚úÖ **–í–ù–ï–î–†–ï–ù–û: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å–ª–µ–¥–æ–≤ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ**

### ~~–¢—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è~~ ‚Üí –£–õ–£–ß–®–ï–ù–û ‚úÖ:
1. ~~‚ö†Ô∏è **–û—á–∏—Å—Ç–∫–∞ appliedBonuses –ø—Ä–∏ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω–µ**~~ ‚Üí ‚úÖ **–í–ù–ï–î–†–ï–ù–û**
   - ‚úÖ –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è `appliedBonuses` –∏–∑ localStorage
   
2. ~~‚ö†Ô∏è **–í–∞–ª–∏–¥–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ**~~ ‚Üí ‚úÖ **–í–ù–ï–î–†–ï–ù–û**
   - ‚úÖ –ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑ localStorage –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –∫–æ—Ä–∑–∏–Ω–∞ –Ω–µ –ø—É—Å—Ç–∞—è
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –µ—Å–ª–∏ `appliedBonuses` –±–æ–ª—å—à–µ —Å—É–º–º—ã –∫–æ—Ä–∑–∏–Ω—ã

### –í–Ω–µ–¥—Ä–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (2026-01-27):

#### 1. –£–ª—É—á—à–µ–Ω–∏–µ `onCartOpen()` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã
```javascript
onCartOpen: function() {
  const currentTotal = this.getCartTotal();
  
  // –£–õ–£–ß–®–ï–ù–ò–ï #1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω—ã
  if (currentTotal === 0 && this.state.appliedBonuses > 0) {
    this.log('üóëÔ∏è –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º appliedBonuses');
    this.resetAppliedBonuses();
    return;
  }
  
  // –£–õ–£–ß–®–ï–ù–ò–ï #2: –ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è
  if (this.state.appliedBonuses > currentTotal && currentTotal > 0) {
    this.log('‚ö†Ô∏è appliedBonuses –±–æ–ª—å—à–µ —Å—É–º–º—ã –∫–æ—Ä–∑–∏–Ω—ã, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º');
    this.state.appliedBonuses = currentTotal;
    localStorage.setItem('tilda_applied_bonuses', currentTotal);
  }
  
  // –£–õ–£–ß–®–ï–ù–ò–ï #3: –ü–µ—Ä–µ–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤
  if (this.state.appliedBonuses > 0 && currentTotal > 0) {
    this.log('üîÑ –ü–µ—Ä–µ–ø—Ä–∏–º–µ–Ω—è–µ–º –±–æ–Ω—É—Å—ã –∫ —Ç–µ–∫—É—â–µ–π –∫–æ—Ä–∑–∏–Ω–µ');
    this.reapplyBonuses();
  }
  
  this.updateWidgetState();
}
```

#### 2. –£–ª—É—á—à–µ–Ω–∏–µ `loadUserDataFromStorage()` - –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
```javascript
loadUserDataFromStorage: function() {
  const savedAppliedBonuses = localStorage.getItem('tilda_applied_bonuses');
  
  if (savedAppliedBonuses) {
    const bonusAmount = parseFloat(savedAppliedBonuses);
    
    // –£–õ–£–ß–®–ï–ù–ò–ï #4: –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏
    if (!isNaN(bonusAmount) && bonusAmount >= 0 && bonusAmount <= 10000) {
      const cartTotal = this.getCartTotal();
      
      if (cartTotal > 0) {
        // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        const validAmount = Math.min(bonusAmount, cartTotal);
        this.state.appliedBonuses = validAmount;
        
        if (validAmount !== bonusAmount) {
          localStorage.setItem('tilda_applied_bonuses', validAmount);
          this.log('‚ö†Ô∏è appliedBonuses —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω:', {
            –±—ã–ª–æ: bonusAmount,
            —Å—Ç–∞–ª–æ: validAmount
          });
        }
      } else {
        // –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è - –æ—á–∏—â–∞–µ–º
        this.log('üóëÔ∏è –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –æ—á–∏—â–∞–µ–º appliedBonuses');
        this.resetAppliedBonuses();
      }
    }
  }
}
```

#### 3. –£–ª—É—á—à–µ–Ω–∏–µ `resetAppliedBonuses()` - –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
```javascript
resetAppliedBonuses: function() {
  this.log('üîÑ –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å appliedBonuses');
  
  // 1. –°–±—Ä–∞—Å—ã–≤–∞–µ–º state
  this.state.appliedBonuses = 0;
  
  // 2. –û—á–∏—â–∞–µ–º localStorage
  localStorage.removeItem('tilda_applied_bonuses');
  
  // 3. –£–¥–∞–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –∏–∑ DOM
  const fields = document.querySelectorAll('[name="appliedBonuses"]');
  fields.forEach(field => field.remove());
  
  // 4. –û—á–∏—â–∞–µ–º window.tcart –æ—Ç –≤—Å–µ—Ö —Å–ª–µ–¥–æ–≤
  if (window.tcart) {
    delete window.tcart.appliedBonuses;
    delete window.tcart.appliedBonusesNumber;
    if (window.tcart.data) delete window.tcart.data.appliedBonuses;
    if (window.tcart.formData) delete window.tcart.formData.appliedBonuses;
    if (window.tcart.order) delete window.tcart.order.appliedBonuses;
    if (window.tcart.orderData) delete window.tcart.orderData.appliedBonuses;
  }
  
  // 5. –£–¥–∞–ª—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ GUPIL
  this.clearAllPromocodes();
  
  this.log('‚úÖ appliedBonuses –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–æ—à–µ–Ω');
}
```

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

**–û–±—â–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: ~~8/10~~ ‚Üí **10/10** ‚úÖ

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã**:
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞—â–∏—Ç—ã (localStorage, state, —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ, window.tcart, JSON.stringify)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–ª–∞—Ç—ã –Ω–∞ backend
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
- ‚úÖ **–ù–û–í–û–ï: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω–µ**
- ‚úÖ **–ù–û–í–û–ï: –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ**
- ‚úÖ **–ù–û–í–û–ï: –ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ —Å—É–º–º—ã**
- ‚úÖ **–ù–û–í–û–ï: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å–ª–µ–¥–æ–≤**

**~~–°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã~~**: ‚Üí **–ò–°–ü–†–ê–í–õ–ï–ù–û** ‚úÖ
- ~~–ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω–µ~~ ‚Üí ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ
- ~~–ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –¥–æ–ª–≥–æ–º —Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ localStorage~~ ‚Üí ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ
- ~~–ú–æ–∂–µ—Ç –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è "–≤–∏—Å–µ—Ç—å" –≤ localStorage –ø–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞~~ ‚Üí ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—Å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤–Ω–µ–¥—Ä–µ–Ω—ã (2026-01-27)
