# Руководство по аналитике заказов и товаров

## Обзор

Система автоматически собирает и анализирует данные о заказах и товарах, поступающих через webhook интеграцию.

## Что отслеживается

### Заказы
- **Номер заказа** - уникальный идентификатор
- **Сумма заказа** - общая стоимость
- **Оплачено** - сумма оплаченная деньгами
- **Бонусами** - сумма оплаченная бонусами
- **Статус** - PENDING, CONFIRMED, PROCESSING, SHIPPED, DELIVERED, CANCELLED, REFUNDED
- **Способ оплаты** - из данных Tilda (yakassa, и т.д.)
- **Способ доставки** - из данных Tilda
- **Адрес доставки** - полный адрес с индексом и городом
- **Данные клиента** - имя, email, телефон
- **UTM-метки** - utm_source, utm_medium, utm_campaign, utm_content, utm_term, utm_ref
- **Cookies** - данные cookies для аналитики
- **Form ID** - идентификатор формы Tilda
- **MA ID** - идентификатор из маркетинговой автоматизации
- **Метаданные** - все raw данные из webhook

### Товары
- **Название** - из заказа
- **SKU** - артикул товара (если указан)
- **Цена** - стоимость за единицу
- **Количество** - в заказе
- **Категория** - если настроена
- **Изображение** - ссылка на картинку товара из Tilda
- **Опции** - вес, размер, цвет и другие параметры
- **External ID** - идентификатор из Tilda
- **Метаданные** - все дополнительные данные из Tilda

### Позиции заказа (OrderItem)
- Связь заказа с товаром
- Количество
- Цена на момент заказа
- Итоговая сумма

## API Endpoints

### GET /api/projects/[id]/analytics/orders

Получить аналитику по заказам.

**Query параметры:**
- `period` - период анализа: `7d`, `30d`, `90d`, `1y` (по умолчанию `30d`)

**Ответ:**
```json
{
  "period": "30d",
  "stats": {
    "totalOrders": 150,
    "totalRevenue": 450000,
    "totalBonusUsed": 25000,
    "averageOrderValue": 3000
  },
  "orders": [
    {
      "id": "...",
      "orderNumber": "1038965815",
      "status": "CONFIRMED",
      "totalAmount": 1440,
      "bonusAmount": 0,
      "paidAmount": 1440,
      "itemsCount": 1,
      "user": {
        "email": "mary.85@mail.ru",
        "phone": "+79262231297"
      },
      "createdAt": "2026-01-27T...",
      "items": [...]
    }
  ],
  "topProducts": [
    {
      "productId": "...",
      "name": "Спелое авокадо",
      "ordersCount": 45,
      "totalQuantity": 60,
      "totalRevenue": 86400
    }
  ],
  "ordersByDay": [
    {
      "date": "2026-01-27",
      "count": 12,
      "total": 36000
    }
  ]
}
```

### GET /api/projects/[id]/analytics/products

Получить аналитику по товарам.

**Query параметры:**
- `period` - период анализа: `7d`, `30d`, `90d`, `1y` (по умолчанию `30d`)

**Ответ:**
```json
{
  "period": "30d",
  "products": [
    {
      "id": "...",
      "name": "Спелое авокадо",
      "sku": "00212",
      "price": 1440,
      "category": "Фрукты",
      "isActive": true,
      "stats": {
        "totalQuantity": 60,
        "totalRevenue": 86400,
        "ordersCount": 45,
        "averagePrice": 1440
      }
    }
  ],
  "categories": [
    {
      "categoryId": "...",
      "name": "Фрукты",
      "ordersCount": 120,
      "totalRevenue": 350000
    }
  ],
  "summary": {
    "totalProducts": 50,
    "activeProducts": 48,
    "productsWithSales": 35
  }
}
```

## Страница аналитики

Доступна по адресу: `/dashboard/projects/[id]/analytics`

### Возможности

1. **Выбор периода**
   - Последние 7 дней
   - Последние 30 дней
   - Последние 90 дней
   - Последний год

2. **Карточки статистики**
   - Всего заказов
   - Общая выручка
   - Средний чек
   - Использовано бонусов

3. **Вкладка "Заказы"**
   - Список последних 20 заказов
   - Информация о клиенте
   - Статус заказа
   - Сумма и использованные бонусы
   - Время создания

4. **Вкладка "Товары"**
   - Все товары с продажами
   - SKU и категория
   - Количество заказов
   - Проданное количество
   - Общая выручка

5. **Вкладка "Топ товаров"**
   - Топ-10 по выручке
   - Рейтинг с номерами
   - Количество заказов и штук
   - Общая выручка

## Автоматическое создание товаров

При обработке заказа система:

1. Проверяет наличие товара по SKU
2. Если товар не найден - создает новый
3. Сохраняет все данные из Tilda в metadata
4. Связывает товар с позицией заказа

## Структура данных из Tilda

Пример полных данных, которые сохраняются:

```json
{
  "date": "27-01-2026",
  "name": "Мария",
  "email": "mary.85@mail.ru",
  "phone": "+79262231297",
  "ma_id": 40198757,
  "formid": "form840467801",
  "formname": "Cart",
  "COOKIES": "previousUrl=...; tildasid=...; tildauid=...",
  "utm_ref": "rectjZUkYcHM9hQVV",
  "utm_source": "...",
  "utm_medium": "...",
  "utm_campaign": "...",
  "payment": {
    "sys": "yakassa",
    "amount": "1440",
    "orderid": "1038965815",
    "systranid": "31092e38-000f-5001-8000-1e8b45f623ef",
    "delivery": "Зеленая зона. Бесплатная доставка.",
    "delivery_price": 0,
    "delivery_fio": "",
    "delivery_zip": "119192",
    "delivery_city": "Москва",
    "delivery_address": "RU: 119192, Москва, пр-кт Мичуринский, д. 34, кв/оф. 453, подъезд 7",
    "delivery_comment": "",
    "subtotal": "1440",
    "products": [
      {
        "img": "https://static.tildacdn.com/stor6130-3762-4132-b561-346261366432/96865396.jpg",
        "sku": "00212",
        "name": "Спелое авокадо",
        "price": "1440",
        "amount": 1440,
        "quantity": 1,
        "options": [
          {
            "option": "вес",
            "variant": "1кг"
          }
        ],
        "externalid": "kbyWJWlwiIfwIak9n-2uB0#dlV5H1b9i3RMsOIvdv7J60"
      }
    ]
  }
}
```

**Все эти данные сохраняются:**
- В таблице `orders` - основная информация + metadata с полными raw данными
- В таблице `order_items` - товары с изображениями и опциями
- В таблице `products` - каталог товаров с изображениями
- В таблице `analytics_events` - события для дальнейшего анализа

## Связь с бонусной системой

Аналитика интегрирована с бонусной системой:

- Отслеживается использование бонусов в заказах
- Учитывается при расчете выручки
- Показывается отдельно в статистике
- Влияет на средний чек

## Производительность

- Используются индексы для быстрых запросов
- Агрегация данных на уровне БД
- Кеширование не требуется (данные обновляются редко)
- Поддержка больших объемов данных

## Будущие улучшения

- [ ] Экспорт данных в Excel/CSV
- [ ] Графики продаж по дням
- [ ] Когортный анализ клиентов
- [ ] RFM-сегментация
- [ ] Прогнозирование продаж
- [ ] Интеграция с Google Analytics
- [ ] Автоматические отчеты на email
