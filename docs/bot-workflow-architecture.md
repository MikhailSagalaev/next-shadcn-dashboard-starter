# Архитектура бота и Workflow конструктора

## Схема работы системы

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           SaaS Bonus System                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐             │
│  │   Dashboard     │    │   Bot Settings │    │  Workflow       │             │
│  │   (Next.js)     │    │   Management   │    │  Constructor    │             │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘             │
│           │                       │                       │                   │
│           │                       │                       │                   │
│           ▼                       ▼                       ▼                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        API Layer                                        │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│  │  │ /api/projects│  │ /api/bot    │  │ /api/workflow│  │ /api/templates│   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│           │                       │                       │                   │
│           │                       │                       │                   │
│           ▼                       ▼                       ▼                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Database (PostgreSQL)                           │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│  │  │   Projects  │  │ Bot Settings │  │  Workflows   │  │   Users     │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Telegram Bot (Grammy)                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐             │
│  │   Bot Runner    │    │  Workflow      │    │   Message       │             │
│  │   (Grammy)      │    │  Executor      │    │   Handler       │             │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘             │
│           │                       │                       │                   │
│           │                       │                       │                   │
│           ▼                       ▼                       ▼                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Workflow Engine                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│  │  │   Trigger   │  │   Message    │  │  Condition   │  │   Action    │   │   │
│  │  │   Nodes     │  │    Nodes     │  │    Nodes     │  │    Nodes    │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│  │  ┌─────────────┐  ┌─────────────┐                                     │   │
│  │  │   Delay     │  │    End      │                                     │   │
│  │  │    Nodes    │  │    Nodes    │                                     │   │
│  │  └─────────────┘  └─────────────┘                                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Telegram Users                                       │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Структура Workflow

### Типы нод:

1. **Trigger** (Триггер) - Точка входа в workflow
   - Команды (`/start`, `/help`)
   - Сообщения (любой текст)
   - Callback queries (нажатие кнопок)
   - Webhook (внешние события)

2. **Message** (Сообщение) - Отправка сообщений пользователю
   - Текст сообщения
   - Клавиатура (inline/reply)
   - Вложения (фото, видео, документы)

3. **Condition** (Условие) - Ветвление логики
   - Проверка переменных
   - Операторы: equals, contains, greater, etc.
   - Два выхода: True/False

4. **Action** (Действие) - Выполнение операций
   - API вызовы
   - Запросы к базе данных
   - Установка переменных
   - Отправка уведомлений

5. **Delay** (Задержка) - Пауза в выполнении
   - Задержка в миллисекундах

6. **End** (Завершение) - Конец workflow
   - Завершение выполнения

## Как работает конструктор

### 1. Доступ к конструктору:
- **URL**: `/dashboard/projects/[projectId]/workflow`
- **Навигация**: 
  - Управление ботом → "Конструктор Workflow"
  - Настройки проекта → "Конструктор Workflow"

### 2. Интерфейс конструктора:

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Конструктор Workflow                                    [Сохранить] [Экспорт] │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐    ┌─────────────────────────────────────────────────────┐   │
│  │   Toolbar   │    │                  Canvas                              │   │
│  │             │    │                                                     │   │
│  │  [Trigger]  │    │  ┌─────────┐    ┌─────────┐    ┌─────────┐         │   │
│  │  [Message]  │    │  │ Trigger │───▶│ Message │───▶│  End    │         │   │
│  │  [Condition]│    │  └─────────┘    └─────────┘    └─────────┘         │   │
│  │  [Action]   │    │                                                     │   │
│  │  [Delay]    │    │  ┌─────────┐    ┌─────────┐                         │   │
│  │  [End]      │    │  │Condition│───▶│ Action  │                         │   │
│  └─────────────┘    │  └─────────┘    └─────────┘                         │   │
│                     └─────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    Properties Panel                                     │   │
│  │  Свойства выбранной ноды:                                               │   │
│  │  - Название                                                             │   │
│  │  - Описание                                                             │   │
│  │  - Конфигурация                                                        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3. Процесс создания workflow:

1. **Создание workflow**:
   - Нажать "Создать новый"
   - Ввести название и описание
   - Автоматически создается нода Trigger

2. **Добавление нод**:
   - Перетащить ноду из панели инструментов
   - Или кликнуть на кнопку ноды
   - Нода появится на canvas

3. **Связывание нод**:
   - Перетащить от выходного порта одной ноды к входному порту другой
   - Создается связь между нодами

4. **Настройка нод**:
   - Кликнуть на ноду для выбора
   - В панели свойств настроить параметры
   - Сохранить изменения

5. **Сохранение workflow**:
   - Нажать "Сохранить"
   - Workflow сохраняется в базе данных

### 4. Выполнение workflow:

```
Пользователь → Telegram → Bot → Workflow Engine → Ноды → Результат
     │              │         │           │         │        │
     │              │         │           │         │        │
     ▼              ▼         ▼           ▼         ▼        ▼
  /start      →  Grammy  →  Trigger  →  Message  →  End   →  "Привет!"
```

## API Endpoints

### Workflow Management:
- `GET /api/projects/[id]/workflows` - Получить все workflow проекта
- `POST /api/projects/[id]/workflows` - Создать новый workflow
- `GET /api/projects/[id]/workflows/[workflowId]` - Получить конкретный workflow
- `PUT /api/projects/[id]/workflows/[workflowId]` - Обновить workflow
- `DELETE /api/projects/[id]/workflows/[workflowId]` - Удалить workflow

### Bot Management:
- `GET /api/projects/[id]/bot` - Получить настройки бота
- `POST /api/projects/[id]/bot/setup` - Настроить бота
- `GET /api/projects/[id]/bot/status` - Получить статус бота

## База данных

### Таблица `workflows`:
```sql
CREATE TABLE workflows (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT FALSE,
  nodes JSON DEFAULT '[]',
  connections JSON DEFAULT '[]',
  variables JSON DEFAULT '[]',
  settings JSON DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

## Примеры workflow

### 1. Простой приветственный бот:
```
Trigger(/start) → Message("Привет!") → End
```

### 2. Бот с условием:
```
Trigger(/start) → Message("Введите имя:") → Condition(name exists) → Message("Привет, {name}!") → End
```

### 3. Бот с действием:
```
Trigger(/start) → Action(Get user data) → Message("Ваш баланс: {balance}") → End
```

## Интеграция с Telegram

### Grammy Framework:
- Используется для создания Telegram ботов
- Поддерживает все типы сообщений и взаимодействий
- Интегрируется с workflow engine

### Webhook Integration:
- Настройка webhook для получения обновлений
- Обработка входящих сообщений через workflow
- Отправка ответов пользователям

## Мониторинг и отладка

### Логирование:
- Все действия workflow логируются
- Ошибки сохраняются для отладки
- Статистика выполнения нод

### Тестирование:
- Возможность тестирования workflow в режиме разработки
- Пошаговое выполнение для отладки
- Валидация workflow перед активацией
