# Шаблон "Система лояльности" - Документация

## 📋 Описание

Полноценный бот для программы лояльности с автоматической регистрацией пользователей и начислением приветственных бонусов.

## 🎯 Основные возможности

- ✅ Запрос контакта (телефон) или email для регистрации
- ✅ Автоматическая проверка существующих пользователей
- ✅ Создание новых пользователей в системе
- ✅ Начисление 100 приветственных бонусов
- ✅ Отображение баланса для существующих пользователей
- ✅ Условные переходы для разных сценариев

## 🔄 Схема workflow

```
┌─────────────────┐
│  /start         │
│  (trigger)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Приветствие    │
│  (message)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Запрос контакта │
│  (trigger)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Проверка юзера  │
│ (database_query)│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Новый юзер?     │
│  (condition)    │
└────┬───────┬────┘
     │       │
  ДА │       │ НЕТ
     │       │
     ▼       ▼
┌─────────┐ ┌──────────────┐
│ Создать │ │ Приветствие  │
│  юзера  │ │ существующего│
└────┬────┘ └──────┬───────┘
     │             │
     ▼             │
┌─────────┐        │
│Начислить│        │
│ бонусы  │        │
└────┬────┘        │
     │             │
     ▼             │
┌─────────┐        │
│ Успешная│        │
│регистр. │        │
└────┬────┘        │
     │             │
     └─────┬───────┘
           │
           ▼
    ┌─────────────┐
    │ Завершение  │
    │  (flow.end) │
    └─────────────┘
```

## 📝 Детальное описание нод

### 1. Триггер /start
- **Тип**: `trigger.command`
- **Команда**: `/start`
- **Описание**: Запускает workflow при вводе команды /start

### 2. Приветственное сообщение
- **Тип**: `message`
- **Текст**: 
  ```
  🎁 Добро пожаловать в программу лояльности!
  
  💰 Получите приветственные бонусы прямо сейчас!
  
  📱 Для регистрации, пожалуйста, поделитесь вашим номером 
  телефона или укажите email.
  ```

### 3. Запрос контакта
- **Тип**: `trigger.contact`
- **Параметры**:
  - `requestPhone`: true
  - `buttonText`: "📱 Поделиться номером"
- **Описание**: Запрашивает у пользователя телефон через кнопку или ожидает ввод email

### 4. Проверка пользователя
- **Тип**: `action.database_query`
- **Query**: `check_user_by_telegram`
- **Параметры**:
  - `telegramId`: `{{telegram.userId}}`
  - `phone`: `{{telegram.contact.phone}}`
  - `email`: `{{telegram.message.text}}`
- **Результат**: Сохраняется в переменную `user`

### 5. Условие: Новый пользователь?
- **Тип**: `condition`
- **Выражение**: `!get("user") || !get("user").id`
- **Логика**: 
  - `true` → пользователь не найден, нужна регистрация
  - `false` → пользователь существует

### 6. Создание пользователя (если новый)
- **Тип**: `action.database_query`
- **Query**: `create_user`
- **Параметры**:
  - `telegramId`: `{{telegram.userId}}`
  - `username`: `{{telegram.username}}`
  - `firstName`: `{{telegram.firstName}}`
  - `phone`: `{{telegram.contact.phone}}`
  - `email`: `{{telegram.message.text}}`

### 7. Начисление приветственных бонусов
- **Тип**: `action.database_query`
- **Query**: `add_bonus`
- **Параметры**:
  - `userId`: `{{user.id}}`
  - `amount`: 100
  - `type`: "WELCOME"
  - `description`: "Приветственные бонусы"

### 8. Сообщение об успешной регистрации
- **Тип**: `message`
- **Текст**:
  ```
  🎉 Поздравляем с регистрацией!
  
  💰 Вам начислено 100 приветственных бонусов!
  
  ✨ Используйте их для покупок и получайте выгоду!
  ```

### 9. Сообщение для существующего пользователя
- **Тип**: `message`
- **Текст**:
  ```
  👋 Рады видеть вас снова!
  
  💰 Ваш текущий баланс: {{user.balance}} бонусов
  
  🛍️ Продолжайте делать покупки и копить бонусы!
  ```

### 10. Завершение
- **Тип**: `flow.end`
- **Параметры**: `{ success: true }`

## 🔧 Переменные workflow

### user (object)
- **Описание**: Данные пользователя из базы данных
- **Поля**:
  - `id`: ID пользователя
  - `telegramId`: Telegram ID
  - `username`: Username в Telegram
  - `firstName`: Имя пользователя
  - `phone`: Номер телефона
  - `email`: Email адрес
  - `balance`: Текущий баланс бонусов

### welcome_bonus (number)
- **Описание**: Размер приветственного бонуса
- **Значение по умолчанию**: 100

## 📊 Связи (Connections)

| ID | Source | Target | Type |
|----|--------|--------|------|
| start-to-welcome | start-trigger | welcome-message | default |
| welcome-to-request | welcome-message | request-contact | default |
| request-to-check | request-contact | check-user | default |
| check-to-condition | check-user | is-new-user | default |
| condition-to-create | is-new-user | create-user | **true** |
| create-to-bonus | create-user | add-welcome-bonus | default |
| bonus-to-success | add-welcome-bonus | success-new-user | default |
| success-to-end | success-new-user | end-node | default |
| condition-to-existing | is-new-user | existing-user-message | **false** |
| existing-to-end | existing-user-message | end-node | default |

## 🎯 Сценарии использования

### Сценарий 1: Новый пользователь с телефоном
1. Пользователь вводит `/start`
2. Получает приветственное сообщение
3. Нажимает кнопку "📱 Поделиться номером"
4. Система проверяет БД - пользователь не найден
5. Создается новый пользователь
6. Начисляется 100 бонусов
7. Отправляется сообщение об успешной регистрации

### Сценарий 2: Новый пользователь с email
1. Пользователь вводит `/start`
2. Получает приветственное сообщение
3. Вводит email вручную
4. Система проверяет БД - пользователь не найден
5. Создается новый пользователь с email
6. Начисляется 100 бонусов
7. Отправляется сообщение об успешной регистрации

### Сценарий 3: Существующий пользователь
1. Пользователь вводит `/start`
2. Получает приветственное сообщение
3. Делится контактом или вводит email
4. Система находит пользователя в БД
5. Отображается текущий баланс бонусов
6. Отправляется приветственное сообщение

## 🔌 Интеграции

### Telegram Bot API
- Получение контактов пользователя
- Отправка сообщений
- Обработка команд

### Database (PostgreSQL + Prisma)
- Проверка существующих пользователей
- Создание новых пользователей
- Начисление бонусов
- Получение баланса

### Bonus System
- Начисление приветственных бонусов
- Отслеживание транзакций
- Управление балансом

## ⚙️ Настройки

- **maxExecutionTime**: 60000 мс (60 секунд)
- **retryAttempts**: 3
- **Размер бонуса**: 100 (настраивается через переменную)

## 🚀 Установка

1. Перейдите в раздел "Шаблоны ботов"
2. Найдите шаблон "Система лояльности" 🎁
3. Нажмите "Установить"
4. Выберите проект
5. Активируйте workflow
6. Настройте токен бота в настройках проекта

## 📈 Возможности расширения

- Добавить уровни лояльности (Bronze, Silver, Gold)
- Настроить размер бонуса в зависимости от источника регистрации
- Добавить реферальную систему
- Интегрировать с CRM системой
- Добавить уведомления о начислении/списании бонусов
- Создать историю транзакций

## 🔐 Безопасность

- Валидация номера телефона
- Проверка формата email
- Защита от дублирования регистраций
- Логирование всех операций с бонусами

## 📞 Поддержка

При возникновении вопросов или проблем:
1. Проверьте логи выполнения workflow
2. Убедитесь что бот имеет доступ к БД
3. Проверьте настройки токена бота
4. Обратитесь в техподдержку

---

**Версия**: 2.0.0  
**Дата создания**: 2025-01-13  
**Последнее обновление**: 2025-10-14  
**Автор**: SaaS Bonus System

