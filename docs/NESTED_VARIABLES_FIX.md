# üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ ConditionHandler

**–î–∞—Ç–∞**: 2025-10-28  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ workflow —Å—Ü–µ–Ω–∞—Ä–∏—è "–°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏" –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: **`ConditionHandler` –Ω–µ –º–æ–≥ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–æ–≤** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `contactUser.telegramId`).

### –°–∏–º–ø—Ç–æ–º—ã

```
üîç ConditionHandler check-telegram-already-linked: variable="contactUser.telegramId" = undefined (undefined)
```

–ü—Ä–∏ —ç—Ç–æ–º –≤ –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ, —á—Ç–æ –æ–±—ä–µ–∫—Ç `contactUser` –°–û–î–ï–†–ñ–ò–¢ –ø–æ–ª–µ `telegramId`:

```
üîç ConditionHandler check-contact-found: variable="contactUser" = {
  "id": "cmh32zyum0005v8kku0wgozw9",
  "telegramId": "524567338",  // ‚Üê –ü–æ–ª–µ –ï–°–¢–¨!
  ...
}
```

### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è

1. ‚ùå –ù–æ–¥–∞ `check-telegram-already-linked` **–≤—Å–µ–≥–¥–∞** –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ `false` (—Ç.–∫. `undefined != empty`)
2. ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º Telegram ID –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞–ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã
3. ‚ùå –ë–∞–ª–∞–Ω—Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–ª—Å—è (100 ‚Üí 200 ‚Üí 300 ‚Üí 400 ‚ÇΩ –ø—Ä–∏ –∫–∞–∂–¥–æ–º `/start`)

---

## üîç –ê–Ω–∞–ª–∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø—Ä–∏—á–∏–Ω—ã

### ‚ùå –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

`ConditionHandler` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤:

```typescript
actualValue = await context.variables.get('contactUser.telegramId', 'session');
```

**–ü—Ä–æ–±–ª–µ–º–∞**: `VariableManager.get()` **–ù–ï —É–º–µ–µ—Ç** —Ä–∞–∑–±–∏—Ä–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø—É—Ç–∏. –û–Ω –∏—Å–∫–∞–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å **–±—É–∫–≤–∞–ª—å–Ω—ã–º** –∫–ª—é—á–æ–º `'contactUser.telegramId'` (–∫–∞–∫ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É), –∞ –Ω–µ —Å–≤–æ–π—Å—Ç–≤–æ `telegramId` —É –æ–±—ä–µ–∫—Ç–∞ `contactUser`.

### ‚úÖ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ò—Å–ø–æ–ª—å–∑—É–µ–º `resolveTemplateValue()` –∏–∑ `utils.ts`:

```typescript
actualValue = await resolveTemplateValue(`{{${variable}}}`, context);
```

**–†–µ—à–µ–Ω–∏–µ**: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `resolveVariablePath()`, –∫–æ—Ç–æ—Ä—ã–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
1. –†–∞–∑–±–∏–≤–∞–µ—Ç –ø—É—Ç—å –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ã: `['contactUser', 'telegramId']`
2. –ü–æ–ª—É—á–∞–µ—Ç –±–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: `contactUser` ‚Üí –æ–±—ä–µ–∫—Ç
3. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ: `object.telegramId` ‚Üí `"524567338"`

---

## üõ†Ô∏è –í–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –§–∞–π–ª: `src/lib/services/workflow/handlers/condition-handler.ts`

#### 1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç —É—Ç–∏–ª–∏—Ç—ã

```typescript
import { resolveTemplateValue } from './utils';
```

#### 2. –ó–∞–º–µ–Ω—ë–Ω –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π

```typescript
// ‚ùå –ë–´–õ–û:
actualValue = await context.variables.get(variable, 'session');

// ‚úÖ –°–¢–ê–õ–û:
actualValue = await resolveTemplateValue(`{{${variable}}}`, context);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ—Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
if (actualValue === `{{${variable}}}`) {
  actualValue = undefined;
}
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

```
üîç ConditionHandler check-telegram-already-linked: variable="contactUser.telegramId" = "524567338" (string)
üîç ConditionHandler check-telegram-already-linked: operator="is_not_empty", result=true ‚úÖ
```

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–ª–æ—É:

```mermaid
graph TD
    A[/start + –∫–æ–Ω—Ç–∞–∫—Ç] --> B[check-telegram-user]
    B --> C{check-user-status}
    C -->|false| D[welcome-message]
    D --> E[check-contact-user]
    E --> F{check-contact-found}
    F -->|true| G{check-telegram-already-linked}
    G -->|true| H[already-active-message ‚úÖ]
    G -->|false| I[activate-user]
    I --> J[check-welcome-bonus]
    J --> K{check-bonus-exists}
    K -->|true| L[add-welcome-bonus]
    K -->|false| M[success-activated-user]
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø–µ—Ä–≤—ã–π `/start`)
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç 100‚ÇΩ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤
- ‚úÖ –ë–∞–ª–∞–Ω—Å: 100‚ÇΩ

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π `/start`)
- ‚úÖ `contactUser.telegramId` = `"524567338"` (is_not_empty = true)
- ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `already-active-message`
- ‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã –ù–ï –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è
- ‚úÖ –ë–∞–ª–∞–Ω—Å –æ—Å—Ç–∞—ë—Ç—Å—è: 100‚ÇΩ (–Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è)

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ü—Ä–∏–º–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|--------|----------|
| `user.balance` | `250` | –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `user.currentLevel` | `"–ë–∞–∑–æ–≤—ã–π"` | –£—Ä–æ–≤–µ–Ω—å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ |
| `contactUser.telegramId` | `"524567338"` | Telegram ID –∏–∑ –ë–î |
| `telegram.userId` | `524567338` | Telegram ID –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ |
| `telegram.contact.phone` | `"+79620024188"` | –¢–µ–ª–µ—Ñ–æ–Ω –∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–∞ |

### –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

- `src/lib/services/workflow/handlers/condition-handler.ts` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
- `src/lib/services/workflow/handlers/utils.ts` ‚Äî —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–µ–∑–æ–ª–≤–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- `–°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è).json` ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

---

## üöÄ –î–µ–ø–ª–æ–π

1. **–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä**:
   ```powershell
   # –ü—Ä–æ—Ü–µ—Å—Å—ã —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   ```

2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º**:
   ```powershell
   pnpm dev
   ```

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å workflow**:
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/start` –≤ –±–æ—Ç–∞
   - –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º
   - –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `/start` + –∫–æ–Ω—Ç–∞–∫—Ç
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±–∞–ª–∞–Ω—Å –ù–ï —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

- [x] `ConditionHandler` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- [x] `contactUser.telegramId` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è
- [x] –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∞
- [x] –î—É–±–ª–∏–∫–∞—Ç—ã –±–æ–Ω—É—Å–æ–≤ –ù–ï –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è
- [x] Changelog –æ–±–Ω–æ–≤–ª—ë–Ω
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.

