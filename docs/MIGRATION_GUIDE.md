# üìö –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏—è–º Prisma

## –û–±–∑–æ—Ä

–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–≤–∞ —Ç–∏–ø–∞ –º–∏–≥—Ä–∞—Ü–∏–π:
1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ Prisma** - —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `prisma migrate dev`
2. **–†—É—á–Ω—ã–µ SQL –º–∏–≥—Ä–∞—Ü–∏–∏** - –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)

```bash
# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ schema.prisma
npx prisma migrate dev --name add_notification_templates

# –ò–ª–∏ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ç–æ–ª—å–∫–æ SQL —Ñ–∞–π–ª–∞ (–±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è)
npx prisma migrate dev --name add_notification_templates --create-only
```

**–í–∞–∂–Ω–æ:**
- –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞—Å—Ç—Å—è –≤ –ø–∞–ø–∫–µ `prisma/migrations/YYYYMMDDHHMMSS_name/migration.sql`
- –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –∫ dev –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- Prisma Client –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω

### 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (production)

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –Ω–µ–ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
npx prisma migrate deploy

# –ò–ª–∏ —á–µ—Ä–µ–∑ npm script
yarn db:migrate
```

**–í–∞–∂–Ω–æ:**
- `migrate deploy` –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑—ã
- –ù–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é Prisma Client (–Ω—É–∂–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ: `npx prisma generate`)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ production –æ–∫—Ä—É–∂–µ–Ω–∏–∏

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, –∞ –∫–∞–∫–∏–µ –Ω–µ—Ç
npx prisma migrate status
```

### 4. –†—É—á–Ω—ã–µ SQL –º–∏–≥—Ä–∞—Ü–∏–∏

–ï—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—à–∏–±–∫–∞ shadow database), –º–æ–∂–Ω–æ:

#### –í–∞—Ä–∏–∞–Ω—Ç A: –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é

```bash
# –ß–µ—Ä–µ–∑ psql
psql -h localhost -U bonus_admin -d bonus_saas -f prisma/migrations/add_notification_templates.sql

# –ò–ª–∏ —á–µ—Ä–µ–∑ docker
docker exec -i postgres_container psql -U bonus_admin -d bonus_saas < prisma/migrations/add_notification_templates.sql
```

#### –í–∞—Ä–∏–∞–Ω—Ç B: –ü–æ–º–µ—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—É—é

–ï—Å–ª–∏ SQL —É–∂–µ –ø—Ä–∏–º–µ–Ω—ë–Ω –≤—Ä—É—á–Ω—É—é, –Ω–æ Prisma –Ω–µ –∑–Ω–∞–µ—Ç –æ–± —ç—Ç–æ–º:

```bash
# –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é
mkdir -p prisma/migrations/20250130120000_add_notification_templates

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å SQL —Ñ–∞–π–ª
cp prisma/migrations/add_notification_templates.sql prisma/migrations/20250130120000_add_notification_templates/migration.sql

# –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—É—é
npx prisma migrate resolve --applied 20250130120000_add_notification_templates
```

## üõ†Ô∏è –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: Shadow database –æ—à–∏–±–∫–∞ (P3006)

**–û—à–∏–±–∫–∞:**
```
Error: P3006
Migration failed to apply cleanly to the shadow database.
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä—É—á–Ω—É—é SQL –º–∏–≥—Ä–∞—Ü–∏—é (—Å–º. –≤—ã—à–µ)
2. –ò–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å shadow database:
   ```bash
   # –û—á–∏—Å—Ç–∏—Ç—å shadow database
   npx prisma migrate reset --skip-seed
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–∏–≥—Ä–∞—Ü–∏—è failed (P3009)

**–û—à–∏–±–∫–∞:**
```
Error: P3009
Migration `20250130_add_feature` failed to apply.
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é
npx prisma migrate resolve --applied 20250130_add_feature

# –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å
npx prisma migrate resolve --rolled-back 20250130_add_feature
```

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
SELECT EXISTS (
   SELECT FROM information_schema.tables 
   WHERE table_schema = 'public' 
   AND table_name = 'notification_templates'
);
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL
2. –ü–æ–º–µ—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—É—é —á–µ—Ä–µ–∑ `migrate resolve`

## üìã –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

1. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π:**
   ```bash
   npx prisma migrate status
   ```

2. ‚úÖ **–°–æ–∑–¥–∞—Ç—å backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
   ```bash
   pg_dump -h localhost -U bonus_admin -d bonus_saas > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

3. ‚úÖ **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:**
   ```bash
   # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   npx prisma migrate deploy
   
   # –ò–ª–∏ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL
   psql -h localhost -U bonus_admin -d bonus_saas -f prisma/migrations/add_notification_templates.sql
   ```

4. ‚úÖ **–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client:**
   ```bash
   npx prisma generate
   ```

5. ‚úÖ **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
   ```bash
   pm2 restart bonus-app
   ```

6. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π

## üìù –ü—Ä–∏–º–µ—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–π –≤ –ø—Ä–æ–µ–∫—Ç–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
- `20251126220424_add_mailing_history_and_tracking/` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫
- `20251125095713_create_referral_levels_table/` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —É—Ä–æ–≤–Ω–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤

### –†—É—á–Ω—ã–µ SQL –º–∏–≥—Ä–∞—Ü–∏–∏:
- `add_notification_templates.sql` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —à–∞–±–ª–æ–Ω–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `add_system_logs_manual.sql` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤
- `add_email_verification_manual.sql` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ email

## üîç –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π
ls -la prisma/migrations/

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –º–∏–≥—Ä–∞—Ü–∏–∏
cat prisma/migrations/20250130_add_feature/migration.sql

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î
psql -h localhost -U bonus_admin -d bonus_saas -c "\d notification_templates"

# –û—Ç–∫–∞—Ç –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π (—Ç–æ–ª—å–∫–æ –≤ dev!)
npx prisma migrate reset
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏** - —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –Ω–æ–≤—ã–µ
2. **–í—Å–µ–≥–¥–∞ –¥–µ–ª–∞–π—Ç–µ backup –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–π –≤ production**
3. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º**
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `IF NOT EXISTS` –≤ —Ä—É—á–Ω—ã—Ö SQL –º–∏–≥—Ä–∞—Ü–∏—è—Ö** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
5. **–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ Prisma Client**

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Prisma Migrate](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [Prisma Migrate Troubleshooting](https://www.prisma.io/docs/guides/migrate/troubleshooting-development)
- –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `docs/FIX_MIGRATIONS.md`, `docs/database-schema.md`

