# ‚úÖ –£–ø—Ä–æ—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞ + –∫–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è

## üéØ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –£–ø—Ä–æ—â–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `flow.wait_contact` —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –Ω–æ–≤—ã–π workflow execution, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–æ—Ç–µ—Ä–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ**: 
- –£–±—Ä–∞–Ω–∞ –Ω–æ–¥–∞ `flow.wait_contact` –∏ –≤—Å—è –ª–æ–≥–∏–∫–∞ waiting state
- –ö–æ–Ω—Ç–∞–∫—Ç —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `context.telegram.contact`
- Workflow –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ª–∏–Ω–µ–π–Ω–æ –±–µ–∑ —Ä–∞–∑—Ä—ã–≤–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –Ω–æ–¥
**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ**:
- –ö–Ω–æ–ø–∫–∞ "–í—ã—Ä–∞–≤–Ω—è—Ç—å" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `dagre` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–∏ –≥—Ä–∞—Ñ–∞
- –ê–ª–≥–æ—Ä–∏—Ç–º: —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ (LR), —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏ –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ viewport –ø–æ—Å–ª–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è

## üìù –£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –∫–æ–¥

### –£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `src/features/workflow/components/nodes/wait-contact-node.tsx`
- `src/lib/services/workflow/handlers/contact-handler.ts`

### –£–¥–∞–ª–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ —Ç–∏–ø—ã:
```typescript
// –ò–∑ src/types/workflow.ts
interface WaitContactFlowConfig { ... }
interface WaitResult { ... }
interface WaitingState { ... }

// –ò–∑ WorkflowNodeType
'flow.wait_contact'
```

### –£–¥–∞–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
```typescript
// –ò–∑ ExecutionContextManager
findWaitingExecution()
resumeContext()
markWaiting()
```

## üîÑ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Frontend:
1. `src/features/workflow/components/workflow-constructor.tsx`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `onAutoLayout()` —Å dagre
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
   - –£–¥–∞–ª–µ–Ω—ã case –¥–ª—è `flow.wait_contact`

2. `src/features/workflow/components/workflow-properties.tsx`
   - –£–¥–∞–ª–µ–Ω UI –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `flow.wait_contact`

3. `src/features/workflow/components/workflow-toolbar.tsx`
   - –£–¥–∞–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ –∏ item –¥–ª—è `flow.wait_contact`

4. `src/features/workflow/components/nodes/workflow-node-types.tsx`
   - –£–¥–∞–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –∏ –º–∞–ø–ø–∏–Ω–≥ `WaitContactNode`

### Backend:
5. `src/lib/services/simple-workflow-processor.ts`
   - –£–±—Ä–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è waiting executions
   - –£–ø—Ä–æ—â–µ–Ω –º–µ—Ç–æ–¥ `executeWorkflow` - —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `void` –≤–º–µ—Å—Ç–æ `boolean`
   - –£–¥–∞–ª—ë–Ω –º–µ—Ç–æ–¥ `isWaitResult()`

6. `src/lib/services/workflow/execution-context-manager.ts`
   - –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω –±–µ–∑ –º–µ—Ç–æ–¥–æ–≤ waiting
   - –û—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ: `createContext`, `updateContextForStep`, `completeExecution`, `log`

7. `src/lib/services/workflow/handlers/flow-handlers.ts`
   - –£–¥–∞–ª–µ–Ω –∫–ª–∞—Å—Å `WaitContactFlowHandler`

8. `src/lib/services/workflow/handlers/index.ts`
   - –£–±—Ä–∞–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è `WaitContactFlowHandler`

9. `src/lib/services/workflow/node-handlers-registry.ts`
   - –£–±—Ä–∞–Ω `flow.wait_contact` –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ç–∏–ø–æ–≤

### –¢–∏–ø—ã:
10. `src/types/workflow.ts`
    - –£–¥–∞–ª–µ–Ω—ã: `WaitContactFlowConfig`, `WaitResult`, `WaitingState`
    - –£–ø—Ä–æ—â–µ–Ω `HandlerResult` –¥–æ `string | null`
    - –£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `waiting?` –∏–∑ `ExecutionContext`

### –®–∞–±–ª–æ–Ω:
11. `–°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (—à–∞–±–ª–æ–Ω) (2).json`
    - –£–¥–∞–ª–µ–Ω–∞ –Ω–æ–¥–∞ `wait-contact`
    - –û–±–Ω–æ–≤–ª–µ–Ω—ã connections: `welcome-message` ‚Üí `check-user` –Ω–∞–ø—Ä—è–º—É—é
    - –ò–∑–º–µ–Ω–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: `{{contact.phoneNumber}}` ‚Üí `{{telegram.contact.phoneNumber}}`

## üì¶ –ù–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```json
{
  "dependencies": {
    "dagre": "^0.8.5"
  },
  "devDependencies": {
    "@types/dagre": "^0.7.52"
  }
}
```

## üß™ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

### –°—Ç–∞—Ä–∞—è —Å—Ö–µ–º–∞ (—Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏):
```
1. /start ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è execution #1
2. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å request_contact –∫–Ω–æ–ø–∫–æ–π
3. flow.wait_contact ‚Üí execution #1 –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Å—Ç–∞—Ç—É—Å "waiting"
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç
5. –°–æ–∑–¥–∞—ë—Ç—Å—è –ù–û–í–´–ô execution #2 ‚Üê –ü–†–û–ë–õ–ï–ú–ê!
6. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
```

### –ù–æ–≤–∞—è —Å—Ö–µ–º–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è):
```
1. /start ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è execution
2. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å request_contact –∫–Ω–æ–ø–∫–æ–π
3. –°–ª–µ–¥—É—é—â–∞—è –Ω–æ–¥–∞ —Å—Ä–∞–∑—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç telegram.contact
4. –ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç —É–∂–µ –µ—Å—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
5. –ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ null
6. –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —É—Å–ª–æ–≤–∏–π
```

## üé® –ê–≤—Ç–æ–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ

```typescript
const onAutoLayout = () => {
  const dagreGraph = new dagre.graphlib.Graph();
  dagreGraph.setGraph({ 
    rankdir: 'LR',      // –°–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
    nodesep: 100,       // –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏
    ranksep: 150        // –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —É—Ä–æ–≤–Ω—è–º–∏
  });

  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–¥—ã –∏ edges –≤ –≥—Ä–∞—Ñ
  // –ó–∞–ø—É—Å–∫–∞–µ–º layout
  dagre.layout(dagreGraph);

  // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∫ –Ω–æ–¥–∞–º
  // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º viewport
};
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç workflow —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –∏ –ø–æ–Ω—è—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞
- ‚úÖ –ö—Ä–∞—Å–∏–≤–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –Ω–æ–¥ –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º
- ‚úÖ –ú–∏–Ω—É—Å ~500 —Å—Ç—Ä–æ–∫ —Å–ª–æ–∂–Ω–æ–≥–æ –∫–æ–¥–∞

## üîç Changelog

–û–±–Ω–æ–≤–ª—ë–Ω `docs/changelog.md`:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —É–ø—Ä–æ—â–µ–Ω–∏—è
- –£–∫–∞–∑–∞–Ω—ã –≤—Å–µ —É–¥–∞–ª—ë–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- –û–ø–∏—Å–∞–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏

