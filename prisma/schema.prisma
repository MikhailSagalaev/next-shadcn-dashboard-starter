generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id                   String                @id @default(cuid())
  name                 String
  domain               String?               @unique
  webhookSecret        String                @unique @default(cuid()) @map("webhook_secret")
  bonusPercentage      Decimal               @default(1.0) @map("bonus_percentage") @db.Decimal(5, 2)
  bonusExpiryDays      Int                   @default(365) @map("bonus_expiry_days")
  bonusBehavior        BonusBehavior         @default(SPEND_AND_EARN) @map("bonus_behavior")
  operationMode        OperationMode         @default(WITH_BOT) @map("operation_mode")
  isActive             Boolean               @default(true) @map("is_active")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  botStatus            BotStatus             @default(INACTIVE) @map("bot_status")
  botToken             String?               @map("bot_token")
  botUsername          String?               @map("bot_username")
  ownerId              String?               @map("owner_id")
  bonusLevels          BonusLevel[]
  botFlows             BotFlow[]
  botSettings          BotSettings?
  notifications        Notification[]
  projectVariables     ProjectVariable[]
  owner                AdminAccount?         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  referralProgram      ReferralProgram?
  referralLevels       ReferralLevel[]
  users                User[]
  webhookLogs          WebhookLog[]
  workflowVariables    WorkflowVariable[]
  workflows            Workflow[]
  systemLogs           SystemLog[]
  orders               Order[]
  products             Product[]
  productCategories    ProductCategory[]
  analyticsEvents      AnalyticsEvent[]
  analyticsMetrics     AnalyticsMetric[]
  segments             Segment[]
  mailings             Mailing[]
  mailingTemplates     MailingTemplate[]
  notificationTemplates NotificationTemplate[]
  retailCrmIntegration RetailCrmIntegration?
  ChatChannel          ChatChannel[]
  Chat                 Chat[]

  @@map("projects")
}

model BonusLevel {
  id             String   @id @default(cuid())
  projectId      String   @map("project_id")
  name           String
  minAmount      Decimal  @default(0) @map("min_amount") @db.Decimal(10, 2)
  maxAmount      Decimal? @map("max_amount") @db.Decimal(10, 2)
  bonusPercent   Int      @map("bonus_percent")
  paymentPercent Int      @map("payment_percent")
  order          Int      @default(0)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
  @@map("bonus_levels")
}

model ReferralProgram {
  id                         String            @id @default(cuid())
  projectId                  String            @unique @map("project_id")
  isActive                   Boolean           @default(true) @map("is_active")
  bonusPercent               Int               @default(5) @map("bonus_percent")
  referrerBonus              Decimal           @default(0) @map("referrer_bonus") @db.Decimal(10, 2)
  minPurchaseAmount          Decimal           @default(0) @map("min_purchase_amount") @db.Decimal(10, 2)
  cookieLifetime             Int               @default(30) @map("cookie_lifetime")
  welcomeBonus               Decimal           @default(0) @map("welcome_bonus") @db.Decimal(10, 2)
  welcomeRewardType          WelcomeRewardType @default(BONUS) @map("welcome_reward_type")
  firstPurchaseDiscountPercent Int             @default(0) @map("first_purchase_discount_percent")
  description                String?
  createdAt                  DateTime          @default(now()) @map("created_at")
  updatedAt                  DateTime          @updatedAt @map("updated_at")
  project                    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  levels                     ReferralLevel[]

  @@map("referral_programs")
}

model ReferralLevel {
  id                String          @id @default(cuid())
  projectId         String          @map("project_id")
  referralProgramId String          @map("referral_program_id")
  level             Int
  percent           Decimal         @default(0) @db.Decimal(5, 2)
  isActive          Boolean         @default(true) @map("is_active")
  order             Int             @default(0)
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  project           Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  program           ReferralProgram @relation(fields: [referralProgramId], references: [id], onDelete: Cascade)

  @@unique([projectId, level])
  @@map("referral_levels")
}

model BotSettings {
  id                 String   @id @default(cuid())
  projectId          String   @unique @map("project_id")
  botToken           String   @map("bot_token")
  botUsername        String   @map("bot_username")
  isActive           Boolean  @default(true) @map("is_active")
  welcomeMessage     Json?    @default("{\"text\": \"Добро пожаловать! Отправьте свой номер телефона для привязки аккаунта.\"}") @map("welcome_message")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  messageSettings    Json?    @default("{}") @map("message_settings")
  functionalSettings Json?    @default("{}") @map("functional_settings")
  project            Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("bot_settings")
}

model BotFlow {
  id          String       @id @default(cuid())
  projectId   String       @map("project_id")
  name        String
  description String?
  version     Int          @default(1)
  isActive    Boolean      @default(false) @map("is_active")
  nodes       Json
  connections Json
  variables   Json?
  settings    Json?
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sessions    BotSession[]

  @@map("bot_flows")
}

model BotSession {
  id        String   @id @default(cuid())
  projectId String   @map("project_id")
  userId    String   @map("user_id")
  flowId    String   @map("flow_id")
  state     Json
  variables Json?
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  flow      BotFlow  @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId, flowId])
  @@map("bot_sessions")
}

model User {
  id                String             @id @default(cuid())
  projectId         String             @map("project_id")
  email             String?
  phone             String?
  firstName         String?            @map("first_name")
  lastName          String?            @map("last_name")
  birthDate         DateTime?          @map("birth_date") @db.Date
  telegramId        BigInt?            @map("telegram_id")
  telegramUsername  String?            @map("telegram_username")
  isActive          Boolean            @default(false) @map("is_active")
  registeredAt      DateTime           @default(now()) @map("registered_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  currentLevel      String             @default("Базовый") @map("current_level")
  referralCode      String?            @unique @map("referral_code")
  referredBy        String?            @map("referred_by")
  totalPurchases    Decimal            @default(0) @map("total_purchases") @db.Decimal(10, 2)
  utmCampaign       String?            @map("utm_campaign")
  utmContent        String?            @map("utm_content")
  utmMedium         String?            @map("utm_medium")
  utmSource         String?            @map("utm_source")
  utmTerm           String?            @map("utm_term")
  metadata          Json?              @default("{}")
  bonuses           Bonus[]
  notifications     Notification[]
  transactions      Transaction[]
  orders            Order[]
  analyticsEvents   AnalyticsEvent[]
  segmentMembers    SegmentMember[]
  mailingRecipients MailingRecipient[]
  mailingHistory    MailingHistory[]
  project           Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  referrer          User?              @relation("UserReferrals", fields: [referredBy], references: [id])
  referrals         User[]             @relation("UserReferrals")
  Chat              Chat[]

  @@unique([projectId, email])
  @@unique([projectId, phone])
  @@unique([projectId, telegramId])
  @@map("users")
}

model Bonus {
  id           String        @id @default(cuid())
  userId       String        @map("user_id")
  amount       Decimal       @db.Decimal(10, 2)
  type         BonusType     @default(MANUAL)
  description  String?
  expiresAt    DateTime?     @map("expires_at")
  isUsed       Boolean       @default(false) @map("is_used")
  metadata     Json?
  createdAt    DateTime      @default(now()) @map("created_at")
  referralLevel Int?         @map("referral_level")
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("bonuses")
}

model Transaction {
  id              String          @id @default(cuid())
  userId          String          @map("user_id")
  bonusId         String?         @map("bonus_id")
  amount          Decimal         @db.Decimal(10, 2)
  type            TransactionType
  description     String?
  metadata        Json?
  createdAt       DateTime        @default(now()) @map("created_at")
  appliedPercent  Int?            @map("applied_percent")
  isReferralBonus Boolean         @default(false) @map("is_referral_bonus")
  referralUserId  String?         @map("referral_user_id")
  referralLevel   Int?            @map("referral_level")
  userLevel       String?         @map("user_level")
  bonus           Bonus?          @relation(fields: [bonusId], references: [id])
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

model WebhookLog {
  id        String   @id @default(cuid())
  projectId String   @map("project_id")
  endpoint  String
  method    String
  headers   Json?
  body      Json?
  response  Json?
  status    Int
  success   Boolean
  createdAt DateTime @default(now()) @map("created_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("webhook_logs")
}

model AdminAccount {
  id                       String         @id @default(cuid())
  email                    String         @unique
  passwordHash             String         @map("password_hash")
  role                     String?        @default("ADMIN")
  isActive                 Boolean?       @default(true) @map("is_active")
  emailVerified            Boolean        @default(false) @map("email_verified")
  emailVerificationToken   String?        @map("email_verification_token")
  emailVerificationExpires DateTime?      @map("email_verification_expires")
  twoFactorSecret          String?        @map("two_factor_secret")
  twoFactorTempSecret      String?        @map("two_factor_temp_secret")
  twoFactorEnabled         Boolean        @default(false) @map("two_factor_enabled")
  metadata                 Json?
  createdAt                DateTime?      @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt                DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  projects                 Project[]
  subscriptions            Subscription[]
  payments                 Payment[]

  @@map("admin_accounts")
}

model Notification {
  id        String    @id @default(cuid())
  projectId String    @map("project_id")
  userId    String?   @map("user_id")
  channel   String
  title     String
  message   String
  metadata  Json?
  sentAt    DateTime? @map("sent_at")
  createdAt DateTime  @default(now()) @map("created_at")
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model AlphaTesterApplication {
  id                 String            @id @default(cuid())
  companyName        String
  companySize        String
  website            String
  industry           String
  contactName        String
  contactEmail       String            @unique
  contactPhone       String?
  contactPosition    String
  currentBonusSystem String?
  experienceLevel    String
  motivation         String
  expectations       String?
  cms                String
  technicalSkills    String
  availableTime      String
  agreeToTerms       Boolean
  agreeToNDA         Boolean
  agreeToMarketing   Boolean           @default(false)
  status             AlphaTesterStatus @default(PENDING)
  notes              String?
  reviewedBy         String?
  reviewedAt         DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  @@map("alpha_tester_applications")
}

model Workflow {
  id              String              @id @default(cuid())
  projectId       String              @map("project_id")
  name            String
  description     String?
  isActive        Boolean             @default(false) @map("is_active")
  nodes           Json                @default("[]")
  connections     Json                @default("[]")
  variables       Json                @default("[]")
  settings        Json                @default("{}")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  executions      WorkflowExecution[]
  variableRecords WorkflowVariable[]
  versions        WorkflowVersion[]
  project         Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("workflows")
}

model WorkflowVersion {
  id          String   @id @default(cuid())
  workflowId  String   @map("workflow_id")
  version     Int
  nodes       Json
  entryNodeId String   @map("entry_node_id")
  variables   Json?
  settings    Json?
  isActive    Boolean  @default(false) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, version])
  @@index([workflowId, isActive])
  @@map("workflow_versions")
}

model WorkflowExecution {
  id             String        @id @default(cuid())
  projectId      String        @map("project_id")
  workflowId     String        @map("workflow_id")
  version        Int
  sessionId      String        @map("session_id")
  userId         String?       @map("user_id")
  telegramChatId String?       @map("telegram_chat_id")
  status         String
  startedAt      DateTime      @default(now()) @map("started_at")
  finishedAt     DateTime?     @map("finished_at")
  error          String?
  stepCount      Int?          @map("step_count")
  currentNodeId  String?       @map("current_node_id")
  waitType       String?       @map("wait_type")
  waitPayload    Json?         @map("wait_payload")
  workflow       Workflow      @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  logs           WorkflowLog[]

  @@index([projectId, workflowId, startedAt])
  @@index([sessionId])
  @@index([projectId, telegramChatId, status])
  @@map("workflow_executions")
}

model WorkflowLog {
  id          BigInt            @id @default(autoincrement())
  executionId String            @map("execution_id")
  step        Int
  nodeId      String            @map("node_id")
  nodeType    String            @map("node_type")
  branchKey   String?           @map("branch_key")
  status      String?           @map("status")
  timestamp   DateTime          @default(now())
  level       String            @default("info")
  message     String
  input       Json?
  output      Json?
  error       Json?
  durationMs  Int?              @map("duration_ms")
  data        Json?
  execution   WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId, step])
  @@index([timestamp])
  @@map("workflow_logs")
}

model ProjectVariable {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  key         String
  value       String
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, key])
  @@index([projectId])
  @@map("project_variables")
}

model WorkflowVariable {
  id         BigInt    @id @default(autoincrement())
  projectId  String    @map("project_id")
  workflowId String?   @map("workflow_id")
  userId     String?   @map("user_id")
  sessionId  String?   @map("session_id")
  scope      String
  key        String
  value      Json
  expiresAt  DateTime? @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  workflow   Workflow? @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([projectId, workflowId, userId, sessionId, scope, key], name: "unique_variable")
  @@index([projectId, scope, key])
  @@index([expiresAt])
  @@map("workflow_variables")
}

enum BonusBehavior {
  SPEND_AND_EARN @map("spend_and_earn")
  SPEND_ONLY     @map("spend_only")
  EARN_ONLY      @map("earn_only")
}

enum OperationMode {
  WITH_BOT    @map("with_bot")
  WITHOUT_BOT @map("without_bot")
}

enum BotStatus {
  INACTIVE
  ACTIVE
  ERROR
}

enum BonusType {
  PURCHASE
  BIRTHDAY
  MANUAL
  REFERRAL
  PROMO
  WELCOME
}

enum TransactionType {
  EARN
  SPEND
  EXPIRE
  REFUND
}

enum AdminRole {
  SUPERADMIN
  ADMIN
  MANAGER
}

enum AlphaTesterStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  INACTIVE
}

enum WelcomeRewardType {
  BONUS   @map("bonus")
  DISCOUNT @map("discount")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model SystemLog {
  id        String   @id @default(cuid())
  level     String // info, warn, error, debug
  message   String
  context   Json?
  projectId String?  @map("project_id")
  userId    String?  @map("user_id")
  source    String // bot, webhook, api, workflow
  stack     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([level, createdAt])
  @@index([projectId])
  @@map("system_logs")
}

model SystemSettings {
  id        String   @id @default("system")
  settings  Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model SubscriptionPlan {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  price       Decimal @db.Decimal(10, 2)
  currency    String  @default("RUB")
  interval    String // month, year

  // Лимиты
  maxProjects        Int @map("max_projects")
  maxUsersPerProject Int @map("max_users_per_project")
  maxBots            Int @default(0) @map("max_bots")
  maxNotifications   Int @default(0) @map("max_notifications")

  // Фичи (JSON для гибкости)
  features Json

  isActive  Boolean @default(true) @map("is_active")
  isPublic  Boolean @default(true) @map("is_public")
  sortOrder Int     @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  subscriptions Subscription[]
  discounts     PlanDiscount[]
  payments      Payment[]

  @@map("subscription_plans")
}

model Subscription {
  id             String @id @default(cuid())
  adminAccountId String @map("admin_account_id")
  planId         String @map("plan_id")

  status String // active, cancelled, expired, trial

  // Даты
  startDate    DateTime  @map("start_date")
  endDate      DateTime? @map("end_date")
  trialEndDate DateTime? @map("trial_end_date")
  cancelledAt  DateTime? @map("cancelled_at")

  // Промокод
  promoCodeId String? @map("promo_code_id")

  // Кастомные лимиты (переопределяют план)
  customLimits Json? @map("custom_limits")

  // Биллинг (для будущей интеграции)
  billingEmail    String?   @map("billing_email")
  paymentMethod   String?   @map("payment_method")
  lastPaymentDate DateTime? @map("last_payment_date")
  nextPaymentDate DateTime? @map("next_payment_date")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  adminAccount AdminAccount          @relation(fields: [adminAccountId], references: [id], onDelete: Cascade)
  plan         SubscriptionPlan      @relation(fields: [planId], references: [id])
  promoCode    PromoCode?            @relation(fields: [promoCodeId], references: [id])
  history      SubscriptionHistory[]
  payments     Payment[]

  @@map("subscriptions")
}

model SubscriptionHistory {
  id             String @id @default(cuid())
  subscriptionId String @map("subscription_id")

  action     String // created, upgraded, downgraded, cancelled, renewed
  fromPlanId String? @map("from_plan_id")
  toPlanId   String? @map("to_plan_id")

  reason   String?
  metadata Json?

  performedBy String?  @map("performed_by") // adminId или system
  createdAt   DateTime @default(now()) @map("created_at")

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@map("subscription_history")
}

model PromoCode {
  id          String  @id @default(cuid())
  code        String  @unique
  description String?

  // Тип скидки
  discountType  String  @map("discount_type") // percent, fixed_amount
  discountValue Decimal @map("discount_value") @db.Decimal(10, 2)

  // Применимость
  applicablePlans String[] @map("applicable_plans") // ['pro', 'enterprise'] или [] для всех

  // Ограничения
  maxUses    Int?      @map("max_uses")
  usedCount  Int       @default(0) @map("used_count")
  validFrom  DateTime  @map("valid_from")
  validUntil DateTime? @map("valid_until")

  isActive Boolean @default(true) @map("is_active")

  createdBy String?  @map("created_by") // superadmin id
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  subscriptions Subscription[]

  @@map("promo_codes")
}

model PlanDiscount {
  id     String @id @default(cuid())
  planId String @map("plan_id")

  name        String
  description String?

  discountType  String  @map("discount_type") // percent, fixed_amount
  discountValue Decimal @map("discount_value") @db.Decimal(10, 2)

  // Условия
  minMonths Int? @map("min_months") // например, скидка при оплате за год

  validFrom  DateTime  @map("valid_from")
  validUntil DateTime? @map("valid_until")

  isActive  Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  plan SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("plan_discounts")
}

model Payment {
  id                String   @id @default(cuid())
  adminAccountId    String   @map("admin_account_id")
  subscriptionId    String?  @map("subscription_id")
  planId            String?  @map("plan_id")
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("RUB")
  status            String   // created, pending, succeeded, canceled, failed
  provider          String   @default("yookassa")
  providerPaymentId String   @unique @map("provider_payment_id")
  confirmationUrl   String?  @map("confirmation_url")
  description       String?
  metadata          Json?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  adminAccount AdminAccount   @relation(fields: [adminAccountId], references: [id], onDelete: Cascade)
  subscription Subscription?  @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  plan         SubscriptionPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  @@index([adminAccountId])
  @@index([subscriptionId])
  @@map("payments")
}

model Order {
  id              String           @id @default(cuid())
  projectId       String           @map("project_id")
  userId          String?          @map("user_id")
  orderNumber     String           @unique @map("order_number")
  status          OrderStatus      @default(PENDING)
  totalAmount     Decimal          @map("total_amount") @db.Decimal(10, 2)
  paidAmount      Decimal          @default(0) @map("paid_amount") @db.Decimal(10, 2)
  bonusAmount     Decimal          @default(0) @map("bonus_amount") @db.Decimal(10, 2)
  deliveryAddress String?          @map("delivery_address") @db.Text
  paymentMethod   String?          @map("payment_method")
  deliveryMethod  String?          @map("delivery_method")
  metadata        Json?
  history         OrderHistory[]
  items           OrderItem[]
  analyticsEvents AnalyticsEvent[]
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  project         Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user            User?            @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([projectId, status])
  @@index([projectId, createdAt])
  @@index([userId])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String   @map("order_id")
  productId String?  @map("product_id")
  name      String
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  total     Decimal  @db.Decimal(10, 2)
  metadata  Json?
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model OrderHistory {
  id        String      @id @default(cuid())
  orderId   String      @map("order_id")
  status    OrderStatus
  comment   String?     @db.Text
  changedBy String?     @map("changed_by")
  metadata  Json?
  createdAt DateTime    @default(now()) @map("created_at")
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
  @@map("order_history")
}

model ProductCategory {
  id          String            @id @default(cuid())
  projectId   String            @map("project_id")
  name        String
  description String?           @db.Text
  parentId    String?           @map("parent_id")
  sortOrder   Int               @default(0) @map("sort_order")
  isActive    Boolean           @default(true) @map("is_active")
  metadata    Json?
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  project     Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    ProductCategory[] @relation("CategoryHierarchy")
  products    Product[]

  @@index([projectId])
  @@index([parentId])
  @@map("product_categories")
}

model Product {
  id          String           @id @default(cuid())
  projectId   String           @map("project_id")
  name        String
  sku         String?          @unique
  price       Decimal          @db.Decimal(10, 2)
  categoryId  String?          @map("category_id")
  description String?          @db.Text
  isActive    Boolean          @default(true) @map("is_active")
  metadata    Json?
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  category    ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  items       OrderItem[]
  project     Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([categoryId])
  @@index([sku])
  @@map("products")
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  projectId String   @map("project_id")
  eventType String   @map("event_type")
  userId    String?  @map("user_id")
  orderId   String?  @map("order_id")
  data      Json?
  createdAt DateTime @default(now()) @map("created_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  order     Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([projectId, eventType, createdAt])
  @@index([userId])
  @@index([orderId])
  @@map("analytics_events")
}

model AnalyticsMetric {
  id         String   @id @default(cuid())
  projectId  String   @map("project_id")
  metricType String   @map("metric_type")
  period     String // day, week, month, year
  value      Decimal  @db.Decimal(10, 2)
  metadata   Json?
  date       DateTime @db.Date
  createdAt  DateTime @default(now()) @map("created_at")
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, metricType, period, date])
  @@index([projectId, metricType, date])
  @@map("analytics_metrics")
}

enum SegmentType {
  MANUAL
  AUTO
  DYNAMIC
}

model Segment {
  id          String          @id @default(cuid())
  projectId   String          @map("project_id")
  name        String
  description String?         @db.Text
  rules       Json // Дерево условий для сегментации
  type        SegmentType     @default(MANUAL)
  memberCount Int             @default(0) @map("member_count")
  isActive    Boolean         @default(true) @map("is_active")
  members     SegmentMember[]
  mailings    Mailing[]
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("segments")
}

model SegmentMember {
  id        String   @id @default(cuid())
  segmentId String   @map("segment_id")
  userId    String   @map("user_id")
  addedAt   DateTime @default(now()) @map("added_at")
  segment   Segment  @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([segmentId, userId])
  @@index([segmentId])
  @@index([userId])
  @@map("segment_members")
}

enum MailingType {
  EMAIL
  SMS
  TELEGRAM
  WHATSAPP
  VIBER
}

enum MailingStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  CANCELLED
  FAILED
}

model Mailing {
  id                 String             @id @default(cuid())
  projectId          String             @map("project_id")
  name               String
  type               MailingType
  segmentId          String?            @map("segment_id")
  templateId         String?            @map("template_id")
  status             MailingStatus      @default(DRAFT)
  scheduledAt        DateTime?          @map("scheduled_at")
  sentAt             DateTime?          @map("sent_at")
  completedAt        DateTime?          @map("completed_at")
  clonedFromId       String?            @map("cloned_from_id")
  messageText        String?            @map("message_text") @db.Text
  messageHtml        String?            @map("message_html") @db.Text
  recipients         MailingRecipient[]
  statistics         Json?
  sentCount          Int                @default(0) @map("sent_count")
  openedCount        Int                @default(0) @map("opened_count")
  clickedCount       Int                @default(0) @map("clicked_count")
  failedCount        Int                @default(0) @map("failed_count")
  linkTrackingEnabled Boolean           @default(false) @map("link_tracking_enabled")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  segment            Segment?           @relation(fields: [segmentId], references: [id], onDelete: SetNull)
  template           MailingTemplate?   @relation(fields: [templateId], references: [id], onDelete: SetNull)
  project            Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  clonedFrom         Mailing?           @relation("MailingClones", fields: [clonedFromId], references: [id], onDelete: SetNull)
  clones             Mailing[]          @relation("MailingClones")
  linkClicks         MailingLinkClick[]
  history            MailingHistory[]
  links              MailingLink[]

  @@index([projectId, status])
  @@index([segmentId])
  @@index([clonedFromId])
  @@map("mailings")
}

model MailingTemplate {
  id        String      @id @default(cuid())
  projectId String      @map("project_id")
  name      String
  subject   String
  body      String      @db.Text
  type      MailingType
  isActive  Boolean     @default(true) @map("is_active")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  mailings  Mailing[]
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("mailing_templates")
}

model MailingRecipient {
  id           String    @id @default(cuid())
  mailingId    String    @map("mailing_id")
  userId       String?   @map("user_id")
  email        String?
  phone        String?
  telegramId   String?   @map("telegram_id")
  status       String    @default("PENDING") // PENDING, SENT, FAILED, BOUNCED, DELIVERED
  sentAt       DateTime? @map("sent_at")
  deliveredAt  DateTime? @map("delivered_at")
  openedAt     DateTime? @map("opened_at")
  clickedAt    DateTime? @map("clicked_at")
  openCount    Int       @default(0) @map("open_count")
  clickCount   Int       @default(0) @map("click_count")
  error        String?   @db.Text
  metadata     Json?
  mailing      Mailing   @relation(fields: [mailingId], references: [id], onDelete: Cascade)
  user         User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  linkClicks   MailingLinkClick[]
  history      MailingHistory[]

  @@index([mailingId, status])
  @@index([userId])
  @@index([telegramId])
  @@map("mailing_recipients")
}

model MailingLinkClick {
  id          String           @id @default(cuid())
  mailingId   String           @map("mailing_id")
  recipientId String           @map("recipient_id")
  url         String           @db.Text
  clickedAt   DateTime         @default(now()) @map("clicked_at")
  userAgent   String?          @map("user_agent")
  ipAddress   String?          @map("ip_address")
  metadata    Json?
  mailing     Mailing          @relation(fields: [mailingId], references: [id], onDelete: Cascade)
  recipient   MailingRecipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([mailingId])
  @@index([recipientId])
  @@index([clickedAt])
  @@map("mailing_link_clicks")
}

model MailingHistory {
  id          String           @id @default(cuid())
  mailingId   String           @map("mailing_id")
  userId      String?          @map("user_id")
  recipientId String           @map("recipient_id")
  type        MailingEventType
  timestamp   DateTime         @default(now())
  metadata    Json?
  mailing     Mailing          @relation(fields: [mailingId], references: [id], onDelete: Cascade)
  user        User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  recipient   MailingRecipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  link        MailingLink?     @relation(fields: [linkId], references: [id], onDelete: SetNull)
  linkId      String?          @map("link_id")

  @@index([mailingId, type])
  @@index([userId])
  @@index([recipientId])
  @@index([linkId])
  @@map("mailing_history")
}

model MailingLink {
  id          String           @id @default(cuid())
  mailingId   String           @map("mailing_id")
  originalUrl String           @map("original_url") @db.Text
  shortCode   String           @unique @map("short_code")
  createdAt   DateTime         @default(now()) @map("created_at")
  clicks      MailingHistory[] @relation
  mailing     Mailing          @relation(fields: [mailingId], references: [id], onDelete: Cascade)

  @@index([mailingId])
  @@index([shortCode])
  @@map("mailing_links")
}

enum MailingEventType {
  SENT
  OPENED
  CLICKED
  FAILED
}

model RetailCrmIntegration {
  id            String    @id @default(cuid())
  projectId     String    @unique @map("project_id")
  apiUrl        String    @map("api_url")
  apiKey        String    @map("api_key")
  isActive      Boolean   @default(false) @map("is_active")
  syncOrders    Boolean   @default(true) @map("sync_orders")
  syncCustomers Boolean   @default(true) @map("sync_customers")
  lastSyncAt    DateTime? @map("last_sync_at")
  metadata      Json?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("retailcrm_integrations")
}

enum ChatChannelType {
  TELEGRAM
  WHATSAPP
  INSTAGRAM
  VK
  MESSENGER
  VIBER
}

enum ChatStatus {
  OPEN
  CLOSED
  ARCHIVED
  WAITING
}

model ChatChannel {
  id          String          @id @default(cuid())
  projectId   String          @map("project_id")
  type        ChatChannelType
  name        String
  credentials Json // Зашифрованные учетные данные
  isActive    Boolean         @default(true) @map("is_active")
  metadata    Json?
  chats       Chat[]
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, type])
  @@map("chat_channels")
}

model Chat {
  id            String        @id @default(cuid())
  projectId     String        @map("project_id")
  channelId     String        @map("channel_id")
  userId        String?       @map("user_id")
  externalId    String        @map("external_id") // ID чата во внешней системе
  status        ChatStatus    @default(OPEN)
  lastMessage   String?       @map("last_message") @db.Text
  lastMessageAt DateTime?     @map("last_message_at")
  unreadCount   Int           @default(0) @map("unread_count")
  metadata      Json?
  messages      ChatMessage[]
  channel       ChatChannel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user          User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, channelId, externalId])
  @@index([projectId, status])
  @@index([userId])
  @@index([channelId])
  @@index([lastMessageAt])
  @@map("chats")
}

model ChatMessage {
  id         String   @id @default(cuid())
  chatId     String   @map("chat_id")
  externalId String?  @map("external_id") // ID сообщения во внешней системе
  message    String   @db.Text
  direction  String // INCOMING, OUTGOING
  senderName String?  @map("sender_name")
  senderId   String?  @map("sender_id")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")
  chat       Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId, createdAt])
  @@index([externalId])
  @@map("chat_messages")
}

model NotificationTemplate {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  name        String
  message     String   @db.Text
  imageUrl    String?  @map("image_url")
  buttons     Json?    // Array of { text, url?, callback_data? }
  parseMode   String   @default("HTML") @map("parse_mode") // HTML or Markdown
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("notification_templates")
}
