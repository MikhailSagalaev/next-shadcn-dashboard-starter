---
inclusion: always
---

# Логика бонусной системы

## Базовые сущности
- `Project` (Tenant) - клиент системы
- `User` - конечный пользователь клиента
- `Bonus` - начисленные бонусы с expiry
- `Transaction` - история операций
- `BotSettings` - настройки Telegram бота

## Типичные флоу
1. **Регистрация**: Webhook → создание User
2. **Покупка**: Webhook → начисление Bonus → Transaction
3. **Списание**: Webhook → списание бонусов → Transaction
4. **Telegram**: привязка аккаунта → проверка баланса

## Логика BonusBehavior (КРИТИЧНО)

Логика зависит от того, использовал ли клиент бонусы при оплате.

| Ситуация | SPEND_AND_EARN | SPEND_ONLY | EARN_ONLY |
|----------|----------------|------------|-----------|
| **Клиент НЕ использовал бонусы** | ✅ Начисляем на **полную сумму** | ✅ Начисляем на **полную сумму** | ✅ Начисляем на **полную сумму** |
| **Клиент использовал бонусы** | ✅ Начисляем на **остаток** (сумма - списанные бонусы) | ❌ **НЕ начисляем** | ⚠️ Невозможно (бонусы нельзя тратить) |

### Примеры:
- Покупка 5000₽, бонусы не использованы → начисляем на 5000₽ (все режимы)
- Покупка 5000₽, списали 1000₽ бонусами:
  - `SPEND_AND_EARN` → начисляем на **4000₽** (остаток)
  - `SPEND_ONLY` → **НЕ начисляем**
  - `EARN_ONLY` → не должно произойти (бонусы нельзя тратить)

## Webhook API дизайн
```json
{
  "action": "register_user|purchase|spend_bonuses",
  "payload": { ... }
}
```

## API endpoints
- `POST /api/webhook/[secret]` - основной webhook
- `GET /api/projects` - список проектов
- `POST /api/projects` - создание проекта
- `GET /api/projects/[id]/stats` - статистика проекта
