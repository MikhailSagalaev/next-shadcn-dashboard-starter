/**
 * @file: src/app/api/projects/[id]/bot/route.ts
 * @description: API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ Telegram –±–æ—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞
 * @project: SaaS Bonus System
 * @dependencies: Next.js App Router, Prisma, Grammy
 * @created: 2024-12-31
 * @author: AI Assistant + User
 */

import { NextRequest, NextResponse } from 'next/server';
import { db } from '@/lib/db';
import { ProjectService } from '@/lib/services/project.service';
import { botManager } from '@/lib/telegram/bot-manager';
import type { BotSettings } from '@/types/bonus';
import { logger } from '@/lib/logger';

// CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization'
};

// OPTIONS handler –¥–ª—è CORS preflight
export async function OPTIONS() {
  return new Response(null, { status: 200, headers: corsHeaders });
}

// GET /api/projects/[id]/bot - –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞
export async function GET(
  request: NextRequest,
  context: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await context.params;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
    const project = await ProjectService.getProjectById(id);
    if (!project) {
      return NextResponse.json({ error: '–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' }, { status: 404 });
    }

    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
    const botSettings = await db.botSettings.findUnique({
      where: { projectId: id }
    });

    // –ü–æ–ª—É—á–∞–µ–º welcomeBonusAmount –∏–∑ meta –ø—Ä–æ–µ–∫—Ç–∞
    const welcomeBonusAmount = Number(project.meta?.welcomeBonus || 0);

    // –î–æ–±–∞–≤–ª—è–µ–º welcomeBonusAmount –∫ –æ—Ç–≤–µ—Ç—É
    const response = {
      ...botSettings,
      welcomeBonusAmount
    };

    return NextResponse.json(response, { headers: corsHeaders });
  } catch (error) {
    logger.error(
      '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞',
      { error: error instanceof Error ? error.message : 'Unknown error' },
      'bot-api'
    );
    return NextResponse.json(
      { error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞' },
      { status: 500 }
    );
  }
}

// POST /api/projects/[id]/bot - –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞
export async function POST(
  request: NextRequest,
  context: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await context.params;
    const body = await request.json();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
    const project = await ProjectService.getProjectById(id);
    if (!project) {
      return NextResponse.json({ error: '–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' }, { status: 404 });
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    if (!body.botToken) {
      return NextResponse.json(
        { error: '–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' },
        { status: 400 }
      );
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞ (–±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞)
    if (!body.botToken.match(/^\d+:[A-Za-z0-9_-]{35}$/)) {
      return NextResponse.json(
        { error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞' },
        { status: 400 }
      );
    }

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const defaultMessageSettings = {
      welcomeMessage:
        '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üéâ\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞.',
      balanceMessage: '–í–∞—à –±–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤: {balance}',
      helpMessage:
        '–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n/balance - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å\n/help - –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–º–æ—â—å'
    };

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const defaultFunctionalSettings = {
      showBalance: true,
      showLevel: true,
      showReferral: true,
      showHistory: true,
      showHelp: true
    };

    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    const botSettings = await db.botSettings.upsert({
      where: { projectId: id },
      update: {
        botToken: body.botToken,
        botUsername: body.botUsername || null,
        welcomeMessage:
          body.welcomeMessage || defaultMessageSettings.welcomeMessage,
        messageSettings: body.messageSettings || defaultMessageSettings,
        functionalSettings:
          body.functionalSettings || defaultFunctionalSettings,
        isActive: body.isActive !== undefined ? body.isActive : true
      },
      create: {
        projectId: id,
        botToken: body.botToken,
        botUsername: body.botUsername || null,
        welcomeMessage:
          body.welcomeMessage || defaultMessageSettings.welcomeMessage,
        messageSettings: body.messageSettings || defaultMessageSettings,
        functionalSettings:
          body.functionalSettings || defaultFunctionalSettings,
        isActive: body.isActive !== undefined ? body.isActive : true
      }
    });

    // –°–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –±–æ—Ç–∞ –≤ BotManager –ù–ï –±–ª–æ–∫–∏—Ä—É—è –æ—Ç–≤–µ—Ç API
    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –≤ —Ñ–æ–Ω–µ, —á—Ç–æ–±—ã UI –Ω–µ –∑–∞–≤–∏—Å–∞–ª –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–¥–µ—Ä–∂–∫–∞—Ö Telegram
    setTimeout(() => {
      (async () => {
        try {
          if (botSettings.isActive) {
            const botSettingsForManager = {
              ...botSettings,
              welcomeMessage:
                typeof botSettings.welcomeMessage === 'string'
                  ? botSettings.welcomeMessage
                  : '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üéâ\n\n–≠—Ç–æ –±–æ—Ç –±–æ–Ω—É—Å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã.'
            };
            await botManager.createBot(
              id,
              botSettingsForManager as BotSettings
            );
            logger.info(
              '‚úÖ –ë–æ—Ç —Å–æ–∑–¥–∞–Ω –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω',
              { projectId: id },
              'bot-api'
            );
          } else {
            await botManager.stopBot(id);
            logger.info('üîÑ –ë–æ—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', { projectId: id }, 'bot-api');
          }
        } catch (error) {
          logger.error(
            '–û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º —á–µ—Ä–µ–∑ BotManager (background)',
            { error: error instanceof Error ? error.message : 'Unknown error' },
            'bot-api'
          );
        }
      })();
    }, 0);

    return NextResponse.json(botSettings, { status: 201 });
  } catch (error) {
    logger.error(
      '–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞',
      { error: error instanceof Error ? error.message : 'Unknown error' },
      'bot-api'
    );

    if (error instanceof Error && error.message.includes('Unique constraint')) {
      return NextResponse.json(
        { error: '–¢–æ–∫–µ–Ω –±–æ—Ç–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –¥—Ä—É–≥–æ–º –ø—Ä–æ–µ–∫—Ç–µ' },
        { status: 409 }
      );
    }

    return NextResponse.json(
      { error: '–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞' },
      { status: 500 }
    );
  }
}

// PUT /api/projects/[id]/bot - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞
export async function PUT(
  request: NextRequest,
  context: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await context.params;
    const body = await request.json();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞
    const existingBot = await db.botSettings.findUnique({
      where: { projectId: id }
    });

    if (!existingBot) {
      return NextResponse.json(
        { error: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã' },
        { status: 404 }
      );
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –µ—Å–ª–∏ –æ–Ω –ø–µ—Ä–µ–¥–∞–Ω
    if (body.botToken && !body.botToken.match(/^\d+:[A-Za-z0-9_-]{35}$/)) {
      return NextResponse.json(
        { error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞' },
        { status: 400 }
      );
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const updateData: any = {};
    if (body.botToken !== undefined) updateData.botToken = body.botToken;
    if (body.botUsername !== undefined)
      updateData.botUsername = body.botUsername;
    if (body.welcomeMessage !== undefined)
      updateData.welcomeMessage = body.welcomeMessage;
    if (body.isActive !== undefined) updateData.isActive = body.isActive;

    const updatedBot = await db.botSettings.update({
      where: { projectId: id },
      data: updateData
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –±–æ—Ç–∞ –≤ BotManager
    try {
      if (updatedBot.isActive) {
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è BotManager
        const botSettingsForManager = {
          ...updatedBot,
          welcomeMessage:
            typeof updatedBot.welcomeMessage === 'string'
              ? updatedBot.welcomeMessage
              : '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üéâ\n\n–≠—Ç–æ –±–æ—Ç –±–æ–Ω—É—Å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã.'
        };
        await botManager.updateBot(id, botSettingsForManager as BotSettings);
        logger.info('üîÑ –ë–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω', { projectId: id }, 'bot-api');
      } else {
        await botManager.stopBot(id);
        logger.info('üîÑ –ë–æ—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', { projectId: id }, 'bot-api');
      }
    } catch (error) {
      logger.error(
        '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ —á–µ—Ä–µ–∑ BotManager',
        { error: error instanceof Error ? error.message : 'Unknown error' },
        'bot-api'
      );
    }

    return NextResponse.json(updatedBot);
  } catch (error) {
    logger.error(
      '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞',
      { error: error instanceof Error ? error.message : 'Unknown error' },
      'bot-api'
    );
    return NextResponse.json(
      { error: '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞' },
      { status: 500 }
    );
  }
}

// DELETE /api/projects/[id]/bot - –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –±–æ—Ç–∞
export async function DELETE(
  request: NextRequest,
  context: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await context.params;

    const botSettings = await db.botSettings.findUnique({
      where: { projectId: id }
    });

    if (!botSettings) {
      return NextResponse.json(
        { error: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã' },
        { status: 404 }
      );
    }

    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –±–æ—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    const deactivatedBot = await db.botSettings.update({
      where: { projectId: id },
      data: { isActive: false }
    });

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ –≤ BotManager
    try {
      await botManager.stopBot(id);
      logger.info('üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ API', { projectId: id }, 'bot-api');
    } catch (error) {
      logger.error(
        '–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ BotManager',
        { error: error instanceof Error ? error.message : 'Unknown error' },
        'bot-api'
      );
    }

    return NextResponse.json({
      message: '–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω',
      bot: deactivatedBot
    });
  } catch (error) {
    logger.error(
      '–û—à–∏–±–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –±–æ—Ç–∞',
      { error: error instanceof Error ? error.message : 'Unknown error' },
      'bot-api'
    );
    return NextResponse.json(
      { error: '–û—à–∏–±–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –±–æ—Ç–∞' },
      { status: 500 }
    );
  }
}
