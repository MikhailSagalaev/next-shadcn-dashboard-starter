# üîÑ –°–∫—Ä–∏–ø—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

–ö–æ–ª–ª–µ–∫—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö SaaS Bonus System –Ω–∞ –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

## üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### `migrate-users-to-levels.ts`

–°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É –±–æ–Ω—É—Å–æ–≤ (v2.0).

#### üéØ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:

1. **–°–æ–∑–¥–∞–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –±–æ–Ω—É—Å–æ–≤**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç 3 –±–∞–∑–æ–≤—ã—Ö —É—Ä–æ–≤–Ω—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:
   - ü•â **–ë–∞–∑–æ–≤—ã–π** (–¥–æ 10,000‚ÇΩ): 5% –±–æ–Ω—É—Å–æ–≤, –¥–æ 10% –æ–ø–ª–∞—Ç—ã
   - ü•à **–°–µ—Ä–µ–±—Ä—è–Ω—ã–π** (10,000-20,000‚ÇΩ): 7% –±–æ–Ω—É—Å–æ–≤, –¥–æ 15% –æ–ø–ª–∞—Ç—ã  
   - ü•á **–ó–æ–ª–æ—Ç–æ–π** (—Å–≤—ã—à–µ 20,000‚ÇΩ): 10% –±–æ–Ω—É—Å–æ–≤, –¥–æ 20% –æ–ø–ª–∞—Ç—ã

2. **–†–∞—Å—á–µ—Ç –ø–æ–∫—É–ø–æ–∫**: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É –ø–æ–∫—É–ø–æ–∫

3. **–ü—Ä–∏—Å–≤–æ–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π**: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É–º–º—ã –ø–æ–∫—É–ø–æ–∫

4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**: –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è `totalPurchases` –∏ `currentLevel` –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### üöÄ –ö–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞:

```bash
# –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
npx tsx scripts/migrate-users-to-levels.ts migrate

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
npx tsx scripts/migrate-users-to-levels.ts validate

# –û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (—Å–±—Ä–æ—Å–∏—Ç—å —É—Ä–æ–≤–Ω–∏)
npx tsx scripts/migrate-users-to-levels.ts rollback

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
npx tsx scripts/migrate-users-to-levels.ts
```

#### üìä –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:

```
üöÄ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É –±–æ–Ω—É—Å–æ–≤...

üìä –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: 3

üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–æ–µ–∫—Ç: –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω "–¢–µ—Ö–Ω–∏–∫–∞" (cm123...)
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø—Ä–æ–µ–∫—Ç–µ: 150
   üìù –°–æ–∑–¥–∞–µ–º —É—Ä–æ–≤–Ω–∏ –±–æ–Ω—É—Å–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...
   ‚úÖ –°–æ–∑–¥–∞–Ω–æ 3 —É—Ä–æ–≤–Ω—è –±–æ–Ω—É—Å–æ–≤
   üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: 150
   ‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 10
   ‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 20
   ...
   ‚úÖ –ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –û–±–Ω–æ–≤–ª–µ–Ω–æ: 150 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:
   ‚Ä¢ –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 425
   ‚Ä¢ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: 425
   ‚Ä¢ –°–æ–∑–¥–∞–Ω–æ —É—Ä–æ–≤–Ω–µ–π –±–æ–Ω—É—Å–æ–≤: 9
   ‚Ä¢ –û—à–∏–±–æ–∫: 0
   ‚Ä¢ –ü—Ä–æ–µ–∫—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 3
```

#### ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:

- **–ë—ç–∫–∞–ø**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ –∫–æ–ø–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- **–í—Ä–µ–º—è**: –ú–∏–≥—Ä–∞—Ü–∏—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
- **–û—Ç–∫–∞—Ç**: –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**:
   ```sql
   -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ —É—Ä–æ–≤–Ω—è
   SELECT COUNT(*) FROM users WHERE current_level IS NULL;
   
   -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º
   SELECT current_level, COUNT(*) FROM users GROUP BY current_level;
   
   -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–µ–∫—Ç—ã –±–µ–∑ —É—Ä–æ–≤–Ω–µ–π –±–æ–Ω—É—Å–æ–≤
   SELECT COUNT(*) FROM projects p WHERE NOT EXISTS (
     SELECT 1 FROM bonus_levels bl WHERE bl.project_id = p.id
   );
   ```

2. **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å**:
   - –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ–ª–æ–Ω–∫–∞ "–£—Ä–æ–≤–µ–Ω—å"
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –º–µ—Ç—Ä–∏–∫ –ø–æ —É—Ä–æ–≤–Ω—è–º

3. **Telegram –±–æ—Ç**:
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É `/level`
   - –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω—è –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤

### –®–∞–±–ª–æ–Ω —Å–∫—Ä–∏–ø—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:

```typescript
import { PrismaClient } from '@prisma/client';
import { logger } from '../src/lib/logger';

const db = new PrismaClient();

async function migrateSomething(): Promise<void> {
  try {
    console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é...');
    
    // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏
    
    console.log('‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:', error);
    logger.error('–û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏', { error });
    throw error;
  }
}

async function main() {
  try {
    await db.$connect();
    await migrateSomething();
  } finally {
    await db.$disconnect();
  }
}

if (require.main === module) {
  main();
}
```

### üìã Checklist –¥–ª—è –Ω–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π:

- [ ] –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ rollback
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ README
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–æ–ø–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- [ ] Backup –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

---

**‚ö†Ô∏è –í–∞–∂–Ω–æ**: –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ª—é–±—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–∏!

**üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞**: –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏. 